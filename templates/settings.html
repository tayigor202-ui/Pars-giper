{% extends "base.html" %}

{% block title %}Настройки - OZON Parser{% endblock %}

{% block content %}
<div class="row mb-5">
    <div class="col-12">
        <h1 class="page-title" style="text-shadow: 2px 2px 0px #000, -1px -1px 0px rgba(255,255,255,0.1);">
            <i class="bi bi-cpu neon-glow-cyan" style="color: var(--brand-primary);"></i> СИСТЕМНОЕ ЯДРО
        </h1>
        <p class="page-subtitle"
            style="letter-spacing: 2px; font-weight: 800; color: #64748b; text-shadow: 1px 1px 0px #000;">КОНФИГУРАЦИЯ
            АЛГОРИТМОВ И ХРОНОЛОГИИ</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.1s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-calendar2-week neon-glow-cyan"></i> Хронология Парсинга</h5>
            </div>
            <div class="card-body">
                <div id="schedules-list"></div>

                <button class="btn btn-premium w-100 mb-3" id="add-schedule-btn">
                    <i class="bi bi-plus-circle"></i> Добавить расписание
                </button>

                <button class="btn btn-premium w-100" id="save-schedules-btn">
                    <i class="bi bi-save"></i> Сохранить все расписания
                </button>

                <div id="schedule-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.2s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-database text-neon-cyan"></i> База данных (OZON)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-link-45deg"></i> URL Google Sheets (OZON)</label>
                    <input type="text" class="form-control" id="google-sheet-url"
                        placeholder="https://docs.google.com/spreadsheets/d/...">
                    <small class="text-white-50 d-block mt-1">Ссылка на таблицу с товарами OZON для импорта</small>
                </div>

                <button class="btn btn-premium w-100 mb-3" id="save-sheet-url-btn">
                    <i class="bi bi-save"></i> Сохранить ссылку OZON
                </button>

                <hr style="border-color: rgba(255,255,255,0.2);">

                <div class="mb-3">
                    <p><i class="bi bi-arrow-repeat"></i> Обновить список товаров OZON из Google Sheets</p>
                    <button class="btn btn-premium w-100 mb-2" id="update-db-btn">
                        <i class="bi bi-arrow-repeat"></i> Импортировать OZON
                    </button>
                    <button class="btn btn-danger-premium w-100" id="clear-db-ozon-btn">
                        <i class="bi bi-trash"></i> Очистить таблицу OZON
                    </button>
                </div>

                <div id="db-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.3s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-database text-neon-cyan"></i> База данных (Wildberries)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-link-45deg"></i> URL Google Sheets (WB)</label>
                    <input type="text" class="form-control" id="google-sheet-url-wb"
                        placeholder="https://docs.google.com/spreadsheets/d/...">
                    <small class="text-white-50 d-block mt-1">Ссылка на таблицу с товарами WB для импорта</small>
                </div>

                <button class="btn btn-premium w-100 mb-3" id="save-sheet-url-wb-btn">
                    <i class="bi bi-save"></i> Сохранить ссылку WB
                </button>

                <hr style="border-color: rgba(255,255,255,0.2);">

                <div class="mb-3">
                    <p><i class="bi bi-arrow-repeat"></i> Обновить список товаров WB из Google Sheets</p>
                    <button class="btn btn-premium w-100 mb-2" id="update-db-wb-btn">
                        <i class="bi bi-arrow-repeat"></i> Импортировать WB
                    </button>
                    <button class="btn btn-danger-premium w-100" id="clear-db-wb-btn">
                        <i class="bi bi-trash"></i> Очистить таблицу WB
                    </button>
                </div>

                <div id="db-status-wb" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.32s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-database text-neon-cyan"></i> База данных (Lemana Pro)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-link-45deg"></i> URL Google Sheets (Lemana)</label>
                    <input type="text" class="form-control" id="google-sheet-url-lemana"
                        placeholder="https://docs.google.com/spreadsheets/d/...">
                    <small class="text-white-50 d-block mt-1">Ссылка на таблицу с товарами Lemana для импорта</small>
                </div>

                <button class="btn btn-premium w-100 mb-3" id="save-sheet-url-lemana-btn">
                    <i class="bi bi-save"></i> Сохранить ссылку Lemana
                </button>

                <hr style="border-color: rgba(255,255,255,0.2);">

                <div class="mb-3">
                    <p><i class="bi bi-arrow-repeat"></i> Обновить список товаров Lemana из Google Sheets</p>
                    <button class="btn btn-premium w-100 mb-2" id="update-db-lemana-btn">
                        <i class="bi bi-arrow-repeat"></i> Импортировать Lemana
                    </button>
                    <button class="btn btn-danger-premium w-100" id="clear-db-lemana-btn">
                        <i class="bi bi-trash"></i> Очистить таблицу Lemana
                    </button>
                </div>

                <div id="db-status-lemana" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.35s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-database text-neon-cyan"></i> База данных (Yandex Market)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-link-45deg"></i> URL Google Sheets (YM)</label>
                    <input type="text" class="form-control" id="google-sheet-url-ym"
                        placeholder="https://docs.google.com/spreadsheets/d/...">
                    <small class="text-white-50 d-block mt-1">Ссылка на таблицу с товарами YM для импорта</small>
                </div>

                <button class="btn btn-premium w-100 mb-3" id="save-sheet-url-ym-btn">
                    <i class="bi bi-save"></i> Сохранить ссылку YM
                </button>

                <hr style="border-color: rgba(255,255,255,0.2);">

                <div class="mb-3">
                    <p><i class="bi bi-arrow-repeat"></i> Обновить список товаров YM из Google Sheets</p>
                    <button class="btn btn-premium w-100 mb-2" id="update-db-ym-btn">
                        <i class="bi bi-arrow-repeat"></i> Импортировать YM
                    </button>
                    <button class="btn btn-danger-premium w-100" id="clear-db-ym-btn">
                        <i class="bi bi-trash"></i> Очистить таблицу YM
                    </button>
                </div>

                <div id="db-status-ym" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.4s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-telegram text-neon-cyan"></i> Telegram Уведомления</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-robot"></i> Bot Token</label>
                    <input type="text" class="form-control" id="telegram-bot-token" placeholder="123456789:ABCDEF...">
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-chat-dots"></i> Chat ID</label>
                    <input type="text" class="form-control" id="telegram-chat-id" placeholder="-100123456789">
                </div>

                <button class="btn btn-premium w-100" id="save-telegram-settings-btn">
                    <i class="bi bi-save"></i> Сохранить настройки Telegram
                </button>

                <div id="tg-status" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="main-card reveal" style="animation-delay: 0.4s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-gear-wide-connected neon-glow-cyan"></i> Системная конфигурация
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-hdd-network"></i> DB Host</label>
                        <input type="text" class="form-control" id="sys-db-host" placeholder="localhost">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><i class="bi bi-door-open"></i> Port</label>
                        <input type="text" class="form-control" id="sys-db-port" placeholder="5432">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-database"></i> DB Name</label>
                        <input type="text" class="form-control" id="sys-db-name" placeholder="ParserOzon">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-person-badge"></i> DB User</label>
                        <input type="text" class="form-control" id="sys-db-user" placeholder="postgres">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-shield-lock"></i> DB Password</label>
                        <input type="password" class="form-control" id="sys-db-pass" placeholder="••••••••">
                        <small class="text-white-50">Оставьте пустым, чтобы не менять</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-browser-chrome"></i> CHROME_PATH (опционально)</label>
                        <input type="text" class="form-control" id="sys-chrome-path" placeholder="Автопоиск...">
                    </div>
                    <div class="col-12">
                        <label class="form-label"><i class="bi bi-key"></i> Flask Secret Key</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="sys-flask-key" readonly>
                            <button class="btn btn-outline-light" type="button" id="generate-key-btn">
                                <i class="bi bi-magic"></i> Сгенерировать
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <button class="btn btn-premium w-100 mb-2" id="save-system-settings-btn">
                            <i class="bi bi-save"></i> Сохранить системные настройки
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-light w-100 mb-2" id="test-db-connection-btn">
                            <i class="bi bi-database-check"></i> Проверить БД
                        </button>
                    </div>
                </div>
                <div id="system-status" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="main-card reveal" style="animation-delay: 0.5s">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="bi bi-cloud-arrow-down neon-glow-cyan"></i> Автоматическое обновление
                    (Git)</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="auto-update-toggle">
                    <label class="form-check-label text-white-50" for="auto-update-toggle">Включить</label>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="update-status-indicator me-3" id="update-indicator"></div>
                    <div>
                        <div class="fw-bold" id="update-status-text">Загрузка статуса...</div>
                        <small class="text-white-50">Последняя проверка: <span
                                id="last-update-check">Никогда</span></small>
                    </div>
                </div>
                <p class="text-white-50 small mb-0">
                    <i class="bi bi-info-circle"></i> Когда функция включена, проект будет каждый час проверять наличие
                    обновлений в Git-репозитории. Если изменения будут найдены, они применятся автоматически, и сервер
                    перезагрузится.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .update-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6c757d;
        box-shadow: 0 0 10px rgba(108, 117, 125, 0.5);
    }

    .update-status-indicator.active {
        background: #00f2fe;
        box-shadow: 0 0 15px rgba(0, 242, 254, 0.8);
        animation: pulse-cyan 2s infinite;
    }

    @keyframes pulse-cyan {
        0% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.2);
            opacity: 0.7;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<div class="row mt-4">
    <div class="col-12">
        <div class="main-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Информация о системе</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <p><strong>Порт веб-интерфейса:</strong><br>3454</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Режим запуска:</strong><br>Development</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Парсер:</strong><br>Ozon Production Final</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .schedule-item {
        background: #0d0f14;
        border-radius: 10px;
        padding: 1.2rem;
        margin-bottom: 1.5rem;
        border: 1px solid #000;
        box-shadow:
            inset 3px 3px 8px #000,
            1px 1px 0px rgba(255, 255, 255, 0.02);
    }

    .schedule-item .form-label {
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        color: #475569;
        margin-bottom: 0.4rem;
    }

    .day-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #1e2229;
        padding: 5px 10px;
        border-radius: 6px;
        border: 1px solid #000;
        box-shadow: 1px 1px 2px #000;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Settings UI initialized');
        let schedules = [];
        let scheduleIdCounter = 1;

        // Helper for safe element access
        const getEl = id => document.getElementById(id);
        const setStatus = (id, msg, isError = false) => {
            const el = getEl(id);
            if (el) el.innerHTML = `<div class="alert ${isError ? 'alert-danger' : ''}">${msg}</div>`;
        };

        // Load saved schedules from backend
        function loadSchedules() {
            console.log('Loading schedules...');
            fetch('/api/schedules')
                .then(r => r.json())
                .then(data => {
                    schedules = data;
                    if (schedules.length > 0) {
                        scheduleIdCounter = Math.max(...schedules.map(s => s.id), 0) + 1;
                    }
                    renderSchedules();
                    loadSchedulerStatus();
                })
                .catch(err => {
                    console.error('Error loading schedules:', err);
                    schedules = [];
                    renderSchedules();
                });
        }

        // Load scheduler status
        function loadSchedulerStatus() {
            fetch('/api/schedules/status')
                .then(r => r.json())
                .then(data => {
                    const statusDiv = getEl('schedule-status');
                    if (!statusDiv) return;

                    if (data.jobs && data.jobs.length > 0) {
                        const statusHtml = '<div class="alert"><i class="bi bi-clock"></i> <strong>Активных задач:</strong> ' + data.jobs.length
                            +
                            '<ul class="mt-2 mb-0">' + data.jobs.map(j => '<li>' + j.name + ' - следующий запуск: ' + j.next_run + '</li>')
                                .join('') + '</ul></div>';
                        statusDiv.innerHTML = statusHtml;
                    } else {
                        statusDiv.innerHTML = '<div class="alert"><i class="bi bi-info-circle"></i> Нет активных задач расписания.</div>';
                    }
                })
                .catch(err => console.error('Error loading scheduler status:', err));
        }

        // Render all schedules
        function renderSchedules() {
            const container = getEl('schedules-list');
            if (!container) return;

            if (schedules.length === 0) {
                container.innerHTML = '<p class="text-white-50 text-center">Нет настроенных расписаний. Нажмите \"Добавить расписание\"</p>';
                return;
            }

            container.innerHTML = schedules.map(schedule => `
<div class="schedule-item" data-id="${schedule.id}">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Расписание #${schedule.id} (${schedule.platform ? schedule.platform.toUpperCase() : 'OZON'})
        </h6>
        <button class="btn btn-danger btn-sm" onclick="window.removeSchedule(${schedule.id})">
            <i class="bi bi-trash"></i>
        </button>
    </div>

    <div class="row g-2 mb-2">
        <div class="col-md-6">
            <label class="form-label">Платформа</label>
            <select class="form-select form-select-sm"
                onchange="window.updateSchedule(${schedule.id}, 'platform', this.value)">
                <option value="ozon" ${schedule.platform === 'ozon' || !schedule.platform ? 'selected' : ''}>OZON
                </option>
                <option value="wb" ${schedule.platform === 'wb' ? 'selected' : ''}>Wildberries</option>
                <option value="lemana" ${schedule.platform === 'lemana' ? 'selected' : ''}>Lemana Pro</option>
                <option value="ym" ${schedule.platform === 'ym' ? 'selected' : ''}>Yandex Market</option>
            </select>
        </div>
        <div class="col-md-6">
            <label class="form-label">Активно</label>
            <select class="form-select form-select-sm"
                onchange="window.updateSchedule(${schedule.id}, 'enabled', this.value)">
                <option value="false" ${!schedule.enabled ? 'selected' : ''}>Отключено</option>
                <option value="true" ${schedule.enabled ? 'selected' : ''}>Включено</option>
            </select>
        </div>
    </div>

    <div class="mb-2">
        <label class="form-label">Время запуска</label>
        <input type="time" class="form-control form-control-sm" value="${schedule.time}"
            onchange="window.updateSchedule(${schedule.id}, 'time', this.value)">
    </div>

    <div class="mb-2">
        <label class="form-label">Дни недели</label>
        <div class="days-checkboxes">
            ${['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].map((day, i) => `
            <div class="day-checkbox">
                <input type="checkbox" class="form-check-input" id="day-${schedule.id}-${i}" ${schedule.days.includes(i)
                    ? 'checked' : ''} onchange="window.updateScheduleDays(${schedule.id})">
                <label class="form-check-label" for="day-${schedule.id}-${i}">${day}</label>
            </div>
            `).join('')}
        </div>
    </div>
</div>
`).join('');
        }

        // Expose helpers to window for inline onchange/onclick
        window.removeSchedule = (id) => {
            if (confirm('Удалить это расписание?')) {
                schedules = schedules.filter(s => s.id !== id);
                renderSchedules();
            }
        };
        window.updateSchedule = (id, field, value) => {
            const schedule = schedules.find(s => s.id === id);
            if (schedule) schedule[field] = field === 'enabled' ? value === 'true' : value;
        };
        window.updateScheduleDays = (id) => {
            const schedule = schedules.find(s => s.id === id);
            if (schedule) {
                schedule.days = [];
                for (let i = 0; i < 7; i++) {
                    const checkbox = getEl(`day-${id}-${i}`); if (checkbox && checkbox.checked)
                        schedule.days.push(i);
                }
            }
        };

        // Add new schedule
        const addBtn = getEl('add-schedule-btn');
        if (addBtn) {
            addBtn.addEventListener('click', () => {
                schedules.push({ id: scheduleIdCounter++, platform: 'ozon', enabled: false, time: '03:00', days: [1, 2, 3, 4, 5] });
                renderSchedules();
            });
        }

        // Save all schedules
        const saveSchedulesBtn = getEl('save-schedules-btn');
        if (saveSchedulesBtn) {
            saveSchedulesBtn.addEventListener('click', function () {
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Сохранение...';
                fetch('/api/schedules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(schedules)
                })
                    .then(r => r.json())
                    .then(data => {
                        setStatus('schedule-status', data.message, data.status !== 'success');
                        if (data.status === 'success') loadSchedulerStatus();
                    })
                    .catch(err => setStatus('schedule-status', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-save"></i> Сохранить все расписания';
                    });
            });
        }

        // Load Config
        function loadConfig() {
            console.log('Loading configuration...');
            fetch('/api/config').then(r => r.json()).then(data => {
                if (data.ozon_spreadsheet_url) getEl('google-sheet-url').value = data.ozon_spreadsheet_url;
                if (data.wb_spreadsheet_url) getEl('google-sheet-url-wb').value = data.wb_spreadsheet_url;
                if (data.lemana_spreadsheet_url) getEl('google-sheet-url-lemana').value = data.lemana_spreadsheet_url;
                if (data.ym_spreadsheet_url) getEl('google-sheet-url-ym').value = data.ym_spreadsheet_url;
            }).catch(err => console.error('Config load error:', err));

            fetch('/api/system/settings').then(r => r.json()).then(data => {
                getEl('sys-db-host').value = data.db_host || '';
                getEl('sys-db-port').value = data.db_port || '';
                getEl('sys-db-name').value = data.db_name || '';
                getEl('sys-db-user').value = data.db_user || '';
                getEl('sys-chrome-path').value = data.chrome_path || '';
                getEl('sys-flask-key').value = data.flask_secret_key || '';
            }).catch(err => console.error('System settings load error:', err));

            fetch('/api/system/update/status').then(r => r.json()).then(data => {
                const toggle = getEl('auto-update-toggle');
                if (toggle) toggle.checked = data.auto_update;
                if (getEl('last-update-check')) getEl('last-update-check').innerText = data.last_check;

                const indicator = getEl('update-indicator');
                const text = getEl('update-status-text');
                if (indicator && text) {
                    if (data.auto_update) {
                        indicator.classList.add('active');
                        text.innerText = 'Автообновление активно (каждый час)';
                    } else {
                        indicator.classList.remove('active');
                        text.innerText = 'Автообновление выключено';
                    }
                }
            }).catch(err => console.error('Update status load error:', err));

            fetch('/api/telegram/settings').then(r => r.json()).then(data => {
                if (data.bot_token) getEl('telegram-bot-token').value = data.bot_token;
                if (data.chat_id) getEl('telegram-chat-id').value = data.chat_id;
            }).catch(err => console.error('Telegram settings load error:', err));
        }

        // Save System Settings
        const saveSysBtn = getEl('save-system-settings-btn');
        if (saveSysBtn) {
            saveSysBtn.addEventListener('click', function () {
                const payload = {
                    db_host: getEl('sys-db-host').value,
                    db_port: getEl('sys-db-port').value,
                    db_name: getEl('sys-db-name').value,
                    db_user: getEl('sys-db-user').value,
                    chrome_path: getEl('sys-chrome-path').value,
                    flask_secret_key: getEl('sys-flask-key').value
                };
                const pass = getEl('sys-db-pass').value;
                if (pass) payload.db_pass = pass;

                this.disabled = true;
                fetch('/api/system/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(data => setStatus('system-status', data.message, data.status !== 'success'))
                    .catch(err => setStatus('system-status', 'Ошибка: ' + err, true))
                    .finally(() => this.disabled = false);
            });
        }

        // Save Spreadsheet URLs
        const saveOzonSheetBtn = getEl('save-sheet-url-btn');
        if (saveOzonSheetBtn) {
            saveOzonSheetBtn.addEventListener('click', function () {
                const url = getEl('google-sheet-url').value;
                this.disabled = true;
                fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ozon_spreadsheet_url: url })
                })
                    .then(r => r.json())
                    .then(data => setStatus('db-status', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status', 'Ошибка: ' + err, true))
                    .finally(() => this.disabled = false);
            });
        }

        const saveWbSheetBtn = getEl('save-sheet-url-wb-btn');
        if (saveWbSheetBtn) {
            saveWbSheetBtn.addEventListener('click', function () {
                const url = getEl('google-sheet-url-wb').value;
                this.disabled = true;
                fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wb_spreadsheet_url: url })
                })
                    .then(r => r.json())
                    .then(data => setStatus('db-status-wb', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status-wb', 'Ошибка: ' + err, true))
                    .finally(() => this.disabled = false);
            });
        }

        const saveYmSheetBtn = getEl('save-sheet-url-ym-btn');
        if (saveYmSheetBtn) {
            saveYmSheetBtn.addEventListener('click', function () {
                const url = getEl('google-sheet-url-ym').value;
                this.disabled = true;
                fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ym_spreadsheet_url: url })
                })
                    .then(r => r.json())
                    .then(data => setStatus('db-status-ym', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status-ym', 'Ошибка: ' + err, true))
                    .finally(() => this.disabled = false);
            });
        }

        // Update Database
        const updateOzonBtn = getEl('update-db-btn');
        if (updateOzonBtn) {
            updateOzonBtn.addEventListener('click', function () {
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Скрипт запущен...';
                fetch('/api/database/update', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => setStatus('db-status', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                    });
            });
        }

        const updateWbBtn = getEl('update-db-wb-btn');
        if (updateWbBtn) {
            updateWbBtn.addEventListener('click', function () {
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Скрипт запущен...';
                fetch('/api/database/update_wb', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => setStatus('db-status-wb', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status-wb', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                    });
            });
        }

        const updateYmBtn = getEl('update-db-ym-btn');
        if (updateYmBtn) {
            updateYmBtn.addEventListener('click', function () {
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Скрипт запущен...';
                fetch('/api/database/update_ym', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => setStatus('db-status-ym', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status-ym', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                    });
            });
        }

        // Clear OZON Database
        const clearOzonBtn = getEl('clear-db-ozon-btn');
        if (clearOzonBtn) {
            clearOzonBtn.addEventListener('click', function () {
                if (!confirm('⚠️ ВНИМАНИЕ! Это удалит ВСЕ данные OZON из таблицы. Продолжить?')) {
                    return;
                }
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Очистка...';
                fetch('/api/database/clear_ozon', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => setStatus('db-status', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                    });
            });
        }

        // Clear WB Database
        const clearWbBtn = getEl('clear-db-wb-btn');
        if (clearWbBtn) {
            clearWbBtn.addEventListener('click', function () {
                if (!confirm('⚠️ ВНИМАНИЕ! Это удалит ВСЕ данные Wildberries из таблицы. Продолжить?')) {
                    return;
                }
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Очистка...';
                fetch('/api/database/clear_wb', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => setStatus('db-status-wb', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status-wb', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                    });
            });
        }

        // Clear Lemana Database
        const clearLemanaBtn = getEl('clear-db-lemana-btn');
        if (clearLemanaBtn) {
            clearLemanaBtn.addEventListener('click', function () {
                if (!confirm('⚠️ ВНИМАНИЕ! Это удалит ВСЕ данные Lemana Pro из таблицы. Продолжить?')) {
                    return;
                }
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Очистка...';
                fetch('/api/database/clear_lemana', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => setStatus('db-status-lemana', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status-lemana', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                    });
            });
        }

        const clearYmBtn = getEl('clear-db-ym-btn');
        if (clearYmBtn) {
            clearYmBtn.addEventListener('click', function () {
                if (!confirm('⚠️ ВНИМАНИЕ! Это удалит ВСЕ данные Yandex Market из таблицы. Продолжить?')) {
                    return;
                }
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Очистка...';
                fetch('/api/database/clear_ym', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => setStatus('db-status-ym', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status-ym', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                    });
            });
        }

        // Telegram Save
        const saveTgBtn = getEl('save-telegram-settings-btn');
        if (saveTgBtn) {
            saveTgBtn.addEventListener('click', function () {
                const payload = {
                    bot_token: getEl('telegram-bot-token').value,
                    chat_id: getEl('telegram-chat-id').value
                };
                this.disabled = true;
                fetch('/api/telegram/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(data => setStatus('tg-status', data.message, data.status !== 'success'))
                    .catch(err => setStatus('tg-status', 'Ошибка: ' + err, true))
                    .finally(() => this.disabled = false);
            });
        }

        // Auto-update Toggle
        const updateToggle = getEl('auto-update-toggle');
        if (updateToggle) {
            updateToggle.addEventListener('change', function () {
                const enabled = this.checked;
                fetch('/api/system/update/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                })
                    .then(r => r.json())
                    .then(data => {
                        const indicator = getEl('update-indicator');
                        const text = getEl('update-status-text');
                        if (enabled) {
                            indicator.classList.add('active');
                            text.innerText = 'Автообновление активно (каждый час)';
                        } else {
                            indicator.classList.remove('active');
                            text.innerText = 'Автообновление выключено';
                        }
                    })
                    .catch(err => console.error('Toggle error:', err));
            });
        }

        // Test DB Connection
        const testDbBtn = getEl('test-db-connection-btn');
        if (testDbBtn) {
            testDbBtn.addEventListener('click', function () {
                const payload = {
                    db_host: getEl('sys-db-host').value,
                    db_port: getEl('sys-db-port').value,
                    db_name: getEl('sys-db-name').value,
                    db_user: getEl('sys-db-user').value,
                    db_pass: getEl('sys-db-pass').value
                };
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Проверка...';
                fetch('/api/database/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(data => setStatus('system-status', data.message, data.status !== 'success'))
                    .catch(err => setStatus('system-status', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                    });
            });
        }

        // Key generation
        const genKeyBtn = getEl('generate-key-btn');
        if (genKeyBtn) {
            genKeyBtn.addEventListener('click', () => {
                const chars = 'abcdef0123456789';
                let key = '';
                for (let i = 0; i < 64; i++) key += chars[Math.floor(Math.random() * chars.length)];
                getEl('sys-flask-key').value = key;
            });
        }

        // Initial load
        loadSchedules();
        loadConfig();

        // Lemana Pro Handlers
        const saveLemanaSheetBtn = getEl('save-sheet-url-lemana-btn');
        if (saveLemanaSheetBtn) {
            saveLemanaSheetBtn.addEventListener('click', function () {
                const url = getEl('google-sheet-url-lemana').value;
                this.disabled = true;
                fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lemana_spreadsheet_url: url })
                })
                    .then(r => r.json())
                    .then(data => setStatus('db-status-lemana', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status-lemana', 'Ошибка: ' + err, true))
                    .finally(() => this.disabled = false);
            });
        }

        const updateLemanaBtn = getEl('update-db-lemana-btn');
        if (updateLemanaBtn) {
            updateLemanaBtn.addEventListener('click', function () {
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Скрипт запущен...';
                fetch('/api/lemana/import', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => setStatus('db-status-lemana', data.message, data.status !== 'success'))
                    .catch(err => setStatus('db-status-lemana', 'Ошибка: ' + err, true))
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                    });
            });
        }
    });
</script>
{% endblock %}