{% extends "base.html" %}

{% block title %}Настройки - OZON Parser{% endblock %}

{% block content %}
<div class="row mb-5 reveal">
    <div class="col-12">
        <h1 class="page-title"><i class="bi bi-sliders neon-glow-cyan"></i> Конфигурация</h1>
        <p class="page-subtitle">Тонкая настройка нейронных алгоритмов и системного расписания</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.1s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-calendar2-week neon-glow-cyan"></i> Хронология Парсинга</h5>
            </div>
            <div class="card-body">
                <div id="schedules-list"></div>

                <button class="btn btn-premium w-100 mb-3" id="add-schedule-btn">
                    <i class="bi bi-plus-circle"></i> Добавить расписание
                </button>

                <button class="btn btn-premium w-100" id="save-schedules-btn">
                    <i class="bi bi-save"></i> Сохранить все расписания
                </button>

                <div id="schedule-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.2s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-database text-neon-cyan"></i> База данных (OZON)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-link-45deg"></i> URL Google Sheets (OZON)</label>
                    <input type="text" class="form-control" id="google-sheet-url"
                        placeholder="https://docs.google.com/spreadsheets/d/...">
                    <small class="text-white-50 d-block mt-1">Ссылка на таблицу с товарами OZON для импорта</small>
                </div>

                <button class="btn btn-premium w-100 mb-3" id="save-sheet-url-btn">
                    <i class="bi bi-save"></i> Сохранить ссылку OZON
                </button>

                <hr style="border-color: rgba(255,255,255,0.2);">

                <div class="mb-3">
                    <p><i class="bi bi-arrow-repeat"></i> Обновить список товаров OZON из Google Sheets</p>
                    <button class="btn btn-premium w-100" id="update-db-btn">
                        <i class="bi bi-arrow-repeat"></i> Импортировать OZON
                    </button>
                </div>

                <div id="db-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.3s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-database text-neon-cyan"></i> База данных (Wildberries)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-link-45deg"></i> URL Google Sheets (WB)</label>
                    <input type="text" class="form-control" id="google-sheet-url-wb"
                        placeholder="https://docs.google.com/spreadsheets/d/...">
                    <small class="text-white-50 d-block mt-1">Ссылка на таблицу с товарами WB для импорта</small>
                </div>

                <button class="btn btn-premium w-100 mb-3" id="save-sheet-url-wb-btn">
                    <i class="bi bi-save"></i> Сохранить ссылку WB
                </button>

                <hr style="border-color: rgba(255,255,255,0.2);">

                <div class="mb-3">
                    <p><i class="bi bi-arrow-repeat"></i> Обновить список товаров WB из Google Sheets</p>
                    <button class="btn btn-premium w-100" id="update-db-wb-btn">
                        <i class="bi bi-arrow-repeat"></i> Импортировать WB
                    </button>
                </div>

                <div id="db-status-wb" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="main-card reveal" style="animation-delay: 0.4s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-send-check neon-glow-cyan"></i> Интеграция с Telegram</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-robot"></i> Bot Token</label>
                            <input type="password" class="form-control" id="telegram-bot-token"
                                placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                            <small class="text-white-50 d-block mt-1">Токен бота из @BotFather</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-chat-dots"></i> Chat ID</label>
                            <input type="text" class="form-control" id="telegram-chat-id"
                                placeholder="-1001234567890 или 123456789">
                            <small class="text-white-50 d-block mt-1">ID чата для отправки отчётов (получите через
                                @userinfobot)</small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-premium w-100 mb-3" id="save-telegram-settings-btn">
                            <i class="bi bi-save"></i> Сохранить настройки Telegram
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-light w-100 mb-3" id="test-telegram-btn">
                            <i class="bi bi-send-check"></i> Проверить подключение
                        </button>
                    </div>
                </div>

                <div id="telegram-status" class="mt-3"></div>

                <hr style="border-color: rgba(255,255,255,0.2);">

                <div class="alert alert-info"
                    style="background: rgba(13, 110, 253, 0.1); border-color: rgba(13, 110, 253, 0.3);">
                    <h6><i class="bi bi-info-circle"></i> Как настроить Telegram:</h6>
                    <ol class="mb-0" style="font-size: 0.9rem;">
                        <li>Создайте бота через @BotFather и получите Bot Token</li>
                        <li>Добавьте бота в ваш чат или группу</li>
                        <li>Получите Chat ID через @userinfobot (для личного чата) или @getmyid_bot (для группы)</li>
                        <li>Введите Bot Token и Chat ID выше и нажмите "Сохранить"</li>
                        <li>Нажмите "Проверить подключение" для тестирования</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="main-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Информация о системе</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <p><strong>Порт веб-интерфейса:</strong><br>3454</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Режим запуска:</strong><br>Development</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Парсер:</strong><br>Ozon Production Final</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .schedule-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .schedule-item .form-label {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .schedule-item .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    .days-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .day-checkbox {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
</style>

<script>
    let schedules = [];
    let scheduleIdCounter = 1;

    // Load saved schedules from backend
    function loadSchedules() {
        fetch('/api/schedules')
            .then(r => r.json())
            .then(data => {
                schedules = data;
                if (schedules.length > 0) {
                    scheduleIdCounter = Math.max(...schedules.map(s => s.id), 0) + 1;
                }
                renderSchedules();
                loadSchedulerStatus();
            })
            .catch(err => {
                console.error('Error loading schedules:', err);
                schedules = [];
                renderSchedules();
            });
    }

    // Load scheduler status
    function loadSchedulerStatus() {
        fetch('/api/schedules/status')
            .then(r => r.json())
            .then(data => {
                if (data.jobs && data.jobs.length > 0) {
                    const statusHtml = '<div class="alert"><i class="bi bi-clock"></i> <strong>Активных задач:</strong> ' + data.jobs.length +
                        '<ul class="mt-2 mb-0">' + data.jobs.map(j => '<li>' + j.name + ' - следующий запуск: ' + j.next_run + '</li>').join('') + '</ul></div>';
                    document.getElementById('schedule-status').innerHTML = statusHtml;
                } else {
                    document.getElementById('schedule-status').innerHTML = '<div class="alert"><i class="bi bi-info-circle"></i> Нет активных задач расписания.</div>';
                }
            })
            .catch(err => console.error('Error loading status:', err));
    }

    // Render all schedules
    function renderSchedules() {
        const container = document.getElementById('schedules-list');
        if (schedules.length === 0) {
            container.innerHTML = '<p class="text-white-50 text-center">Нет настроенных расписаний. Нажмите "Добавить расписание"</p>';
            return;
        }

        container.innerHTML = schedules.map(schedule => `
        <div class="schedule-item" data-id="${schedule.id}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Расписание #${schedule.id} (${schedule.platform ? schedule.platform.toUpperCase() : 'OZON'})</h6>
                <button class="btn btn-danger btn-sm" onclick="removeSchedule(${schedule.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            
            <div class="row g-2 mb-2">
                <div class="col-md-6">
                    <label class="form-label">Платформа</label>
                    <select class="form-select form-select-sm" onchange="updateSchedule(${schedule.id}, 'platform', this.value)">
                        <option value="ozon" ${schedule.platform === 'ozon' || !schedule.platform ? 'selected' : ''}>OZON</option>
                        <option value="wb" ${schedule.platform === 'wb' ? 'selected' : ''}>Wildberries</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Активно</label>
                    <select class="form-select form-select-sm" onchange="updateSchedule(${schedule.id}, 'enabled', this.value)">
                        <option value="false" ${!schedule.enabled ? 'selected' : ''}>Отключено</option>
                        <option value="true" ${schedule.enabled ? 'selected' : ''}>Включено</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Время запуска</label>
                <input type="time" class="form-control form-control-sm" value="${schedule.time}" 
                       onchange="updateSchedule(${schedule.id}, 'time', this.value)">
            </div>
            
            <div class="mb-2">
                <label class="form-label">Дни недели</label>
                <div class="days-checkboxes">
                    ${['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].map((day, i) => `
                        <div class="day-checkbox">
                            <input type="checkbox" class="form-check-input" id="day-${schedule.id}-${i}" 
                                   ${schedule.days.includes(i) ? 'checked' : ''}
                                   onchange="updateScheduleDays(${schedule.id})">
                            <label class="form-check-label" for="day-${schedule.id}-${i}">${day}</label>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');
    }

    // Add new schedule
    document.getElementById('add-schedule-btn').addEventListener('click', () => {
        schedules.push({
            id: scheduleIdCounter++,
            platform: 'ozon',
            enabled: false,
            time: '03:00',
            days: [1, 2, 3, 4, 5] // Mon-Fri
        });
        renderSchedules();
    });

    // Remove schedule
    function removeSchedule(id) {
        if (confirm('Удалить это расписание?')) {
            schedules = schedules.filter(s => s.id !== id);
            renderSchedules();
        }
    }

    // Update schedule field
    function updateSchedule(id, field, value) {
        const schedule = schedules.find(s => s.id === id);
        if (schedule) {
            schedule[field] = field === 'enabled' ? value === 'true' : value;
        }
    }

    // Update schedule days
    function updateScheduleDays(id) {
        const schedule = schedules.find(s => s.id === id);
        if (schedule) {
            schedule.days = [];
            for (let i = 0; i < 7; i++) {
                const checkbox = document.getElementById(`day-${id}-${i}`);
                if (checkbox && checkbox.checked) {
                    schedule.days.push(i);
                }
            }
        }
    }

    // Save all schedules to backend
    document.getElementById('save-schedules-btn').addEventListener('click', function () {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Сохранение...';

        fetch('/api/schedules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(schedules)
        })
            .then(r => r.json())
            .then(data => {
                const statusDiv = document.getElementById('schedule-status');
                if (data.status === 'success') {
                    statusDiv.innerHTML = '<div class="alert"><i class="bi bi-check-circle"></i> ' + data.message + '</div>';
                    loadSchedulerStatus(); // Reload status to show next run times
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ' + data.message + '</div>';
                }
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить все расписания';
            })
            .catch(err => {
                document.getElementById('schedule-status').innerHTML = '<div class="alert alert-danger">Ошибка: ' + err + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить все расписания';
            });
    });

    // Load all config from server
    function loadConfig() {
        fetch('/api/config')
            .then(r => r.json())
            .then(data => {
                if (data.ozon_spreadsheet_url) {
                    document.getElementById('google-sheet-url').value = data.ozon_spreadsheet_url;
                }
                if (data.wb_spreadsheet_url) {
                    document.getElementById('google-sheet-url-wb').value = data.wb_spreadsheet_url;
                }
            })
            .catch(err => console.error('Error loading config:', err));

        // Load Telegram settings separately
        fetch('/api/telegram/settings')
            .then(r => r.json())
            .then(data => {
                if (data.bot_token) {
                    document.getElementById('telegram-bot-token').value = data.bot_token;
                }
                if (data.chat_id) {
                    document.getElementById('telegram-chat-id').value = data.chat_id;
                }
            })
            .catch(err => console.error('Error loading Telegram settings:', err));
    }

    // Google Sheets URL (OZON)
    document.getElementById('save-sheet-url-btn').addEventListener('click', function () {
        const url = document.getElementById('google-sheet-url').value.trim();
        if (!url) {
            alert('Введите URL Google Sheets для Ozon');
            return;
        }

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Сохранение...';

        fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ozon_spreadsheet_url: url })
        })
            .then(r => r.json())
            .then(data => {
                const statusDiv = document.getElementById('db-status');
                if (data.status === 'success') {
                    statusDiv.innerHTML = '<div class="alert"><i class="bi bi-check-circle"></i> URL Ozon сохранён на сервере</div>';
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ' + data.message + '</div>';
                }
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить ссылку OZON';
            })
            .catch(err => {
                document.getElementById('db-status').innerHTML = '<div class="alert alert-danger">Ошибка: ' + err + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить ссылку OZON';
            });
    });

    // Google Sheets URL (WB)
    document.getElementById('save-sheet-url-wb-btn').addEventListener('click', function () {
        const url = document.getElementById('google-sheet-url-wb').value.trim();
        if (!url) {
            alert('Введите URL Google Sheets для Wildberries');
            return;
        }

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Сохранение...';

        fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wb_spreadsheet_url: url })
        })
            .then(r => r.json())
            .then(data => {
                const statusDiv = document.getElementById('db-status-wb');
                if (data.status === 'success') {
                    statusDiv.innerHTML = '<div class="alert"><i class="bi bi-check-circle"></i> URL WB сохранён на сервере</div>';
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ' + data.message + '</div>';
                }
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить ссылку WB';
            })
            .catch(err => {
                document.getElementById('db-status-wb').innerHTML = '<div class="alert alert-danger">Ошибка: ' + err + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить ссылку WB';
            });
    });

    // Database update (OZON)
    document.getElementById('update-db-btn').addEventListener('click', function () {
        const url = document.getElementById('google-sheet-url').value.trim();
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Импорт OZON...';

        fetch('/api/database/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        })
            .then(r => r.json())
            .then(data => {
                const statusDiv = document.getElementById('db-status');
                const alertClass = data.status === 'success' ? 'alert' : 'alert alert-danger';
                statusDiv.innerHTML = '<div class="' + alertClass + '"><i class="bi bi-' + (data.status === 'success' ? 'check' : 'x') + '-circle"></i> ' + data.message + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Импортировать OZON';
            })
            .catch(err => {
                document.getElementById('db-status').innerHTML = '<div class="alert alert-danger">Ошибка: ' + err + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Импортировать OZON';
            });
    });

    // Database update (WB)
    document.getElementById('update-db-wb-btn').addEventListener('click', function () {
        const url = document.getElementById('google-sheet-url-wb').value.trim();
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Импорт WB...';

        fetch('/api/database/update_wb', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        })
            .then(r => r.json())
            .then(data => {
                const statusDiv = document.getElementById('db-status-wb');
                const alertClass = data.status === 'success' ? 'alert' : 'alert alert-danger';
                statusDiv.innerHTML = '<div class="' + alertClass + '"><i class="bi bi-' + (data.status === 'success' ? 'check' : 'x') + '-circle"></i> ' + data.message + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Импортировать WB';
            })
            .catch(err => {
                document.getElementById('db-status-wb').innerHTML = '<div class="alert alert-danger">Ошибка: ' + err + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Импортировать WB';
            });
    });

    // Telegram Settings - Save
    document.getElementById('save-telegram-settings-btn').addEventListener('click', function () {
        const botToken = document.getElementById('telegram-bot-token').value.trim();
        const chatId = document.getElementById('telegram-chat-id').value.trim();

        if (!botToken || !chatId) {
            document.getElementById('telegram-status').innerHTML =
                '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Заполните оба поля: Bot Token и Chat ID</div>';
            return;
        }

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Сохранение...';

        fetch('/api/telegram/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bot_token: botToken, chat_id: chatId })
        })
            .then(r => r.json())
            .then(data => {
                const statusDiv = document.getElementById('telegram-status');
                const alertClass = data.status === 'success' ? 'alert' : 'alert alert-danger';
                statusDiv.innerHTML = '<div class="' + alertClass + '"><i class="bi bi-' + (data.status === 'success' ? 'check' : 'x') + '-circle"></i> ' + data.message + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить настройки Telegram';
            })
            .catch(err => {
                document.getElementById('telegram-status').innerHTML = '<div class="alert alert-danger">Ошибка: ' + err + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить настройки Telegram';
            });
    });

    // Telegram Settings - Test Connection
    document.getElementById('test-telegram-btn').addEventListener('click', function () {
        const botToken = document.getElementById('telegram-bot-token').value.trim();
        const chatId = document.getElementById('telegram-chat-id').value.trim();

        if (!botToken || !chatId) {
            document.getElementById('telegram-status').innerHTML =
                '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Сначала сохраните настройки Telegram</div>';
            return;
        }

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Проверка...';

        fetch('/api/telegram/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bot_token: botToken, chat_id: chatId })
        })
            .then(r => r.json())
            .then(data => {
                const statusDiv = document.getElementById('telegram-status');
                if (data.status === 'success') {
                    let html = '<div class="alert"><i class="bi bi-check-circle"></i> <strong>Подключение успешно!</strong><br>';
                    if (data.bot_info) {
                        html += '<small>Бот: ' + data.bot_info.name + ' (@' + data.bot_info.username + ')</small><br>';
                    }
                    if (data.chat_info) {
                        html += '<small>Чат: ' + data.chat_info.title + ' (ID: ' + data.chat_info.id + ')</small><br>';
                    }
                    html += '<small>✅ Тестовое сообщение отправлено в Telegram</small></div>';
                    statusDiv.innerHTML = html;
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> <strong>Ошибка подключения</strong><br><small>' + data.message + '</small></div>';
                }
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-send-check"></i> Проверить подключение';
            })
            .catch(err => {
                document.getElementById('telegram-status').innerHTML = '<div class="alert alert-danger">Ошибка: ' + err + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-send-check"></i> Проверить подключение';
            });
    });

    // Load data on page load
    loadSchedules();
    loadConfig();
</script>
{% endblock %}