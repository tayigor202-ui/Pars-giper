{% extends "base.html" %}

{% block title %}Настройки - OZON Parser{% endblock %}

{% block content %}
<div class="row mb-5 reveal">
    <div class="col-12">
        <h1 class="page-title"><i class="bi bi-sliders neon-glow-cyan"></i> Конфигурация</h1>
        <p class="page-subtitle">Тонкая настройка нейронных алгоритмов и системного расписания</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.1s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-calendar2-week neon-glow-cyan"></i> Хронология Парсинга</h5>
            </div>
            <div class="card-body">
                <div id="schedules-list"></div>

                <button class="btn btn-premium w-100 mb-3" id="add-schedule-btn">
                    <i class="bi bi-plus-circle"></i> Добавить расписание
                </button>

                <button class="btn btn-premium w-100" id="save-schedules-btn">
                    <i class="bi bi-save"></i> Сохранить все расписания
                </button>

                <div id="schedule-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.2s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-database text-neon-cyan"></i> База данных (OZON)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-link-45deg"></i> URL Google Sheets (OZON)</label>
                    <input type="text" class="form-control" id="google-sheet-url"
                        placeholder="https://docs.google.com/spreadsheets/d/...">
                    <small class="text-white-50 d-block mt-1">Ссылка на таблицу с товарами OZON для импорта</small>
                </div>

                <button class="btn btn-premium w-100 mb-3" id="save-sheet-url-btn">
                    <i class="bi bi-save"></i> Сохранить ссылку OZON
                </button>

                <hr style="border-color: rgba(255,255,255,0.2);">

                <div class="mb-3">
                    <p><i class="bi bi-arrow-repeat"></i> Обновить список товаров OZON из Google Sheets</p>
                    <button class="btn btn-premium w-100" id="update-db-btn">
                        <i class="bi bi-arrow-repeat"></i> Импортировать OZON
                    </button>
                </div>

                <div id="db-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.3s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-database text-neon-cyan"></i> База данных (Wildberries)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-link-45deg"></i> URL Google Sheets (WB)</label>
                    <input type="text" class="form-control" id="google-sheet-url-wb"
                        placeholder="https://docs.google.com/spreadsheets/d/...">
                    <small class="text-white-50 d-block mt-1">Ссылка на таблицу с товарами WB для импорта</small>
                </div>

                <button class="btn btn-premium w-100 mb-3" id="save-sheet-url-wb-btn">
                    <i class="bi bi-save"></i> Сохранить ссылку WB
                </button>

                <hr style="border-color: rgba(255,255,255,0.2);">

                <div class="mb-3">
                    <p><i class="bi bi-arrow-repeat"></i> Обновить список товаров WB из Google Sheets</p>
                    <button class="btn btn-premium w-100" id="update-db-wb-btn">
                        <i class="bi bi-arrow-repeat"></i> Импортировать WB
                    </button>
                </div>

                <div id="db-status-wb" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="main-card h-100 reveal" style="animation-delay: 0.35s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-telegram text-neon-cyan"></i> Telegram Уведомления</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-robot"></i> Bot Token</label>
                    <input type="text" class="form-control" id="telegram-bot-token" placeholder="123456789:ABCDEF...">
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-chat-dots"></i> Chat ID</label>
                    <input type="text" class="form-control" id="telegram-chat-id" placeholder="-100123456789">
                </div>

                <button class="btn btn-premium w-100" id="save-telegram-settings-btn">
                    <i class="bi bi-save"></i> Сохранить настройки Telegram
                </button>

                <div id="tg-status" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="main-card reveal" style="animation-delay: 0.4s">
            <div class="card-header">
                <h5 class="mb-0 fw-bold"><i class="bi bi-gear-wide-connected neon-glow-cyan"></i> Системная конфигурация
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-hdd-network"></i> DB Host</label>
                        <input type="text" class="form-control" id="sys-db-host" placeholder="localhost">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><i class="bi bi-door-open"></i> Port</label>
                        <input type="text" class="form-control" id="sys-db-port" placeholder="5432">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-database"></i> DB Name</label>
                        <input type="text" class="form-control" id="sys-db-name" placeholder="ParserOzon">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-person-badge"></i> DB User</label>
                        <input type="text" class="form-control" id="sys-db-user" placeholder="postgres">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-shield-lock"></i> DB Password</label>
                        <input type="password" class="form-control" id="sys-db-pass" placeholder="••••••••">
                        <small class="text-white-50">Оставьте пустым, чтобы не менять</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-browser-chrome"></i> CHROME_PATH (опционально)</label>
                        <input type="text" class="form-control" id="sys-chrome-path" placeholder="Автопоиск...">
                    </div>
                    <div class="col-12">
                        <label class="form-label"><i class="bi bi-key"></i> Flask Secret Key</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="sys-flask-key" readonly>
                            <button class="btn btn-outline-light" type="button" id="generate-key-btn">
                                <i class="bi bi-magic"></i> Сгенерировать
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <button class="btn btn-premium w-100 mb-2" id="save-system-settings-btn">
                            <i class="bi bi-save"></i> Сохранить системные настройки
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-light w-100 mb-2" id="test-db-connection-btn">
                            <i class="bi bi-database-check"></i> Проверить БД
                        </button>
                    </div>
                </div>
                <div id="system-status" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="main-card reveal" style="animation-delay: 0.5s">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="bi bi-cloud-arrow-down neon-glow-cyan"></i> Автоматическое обновление
                    (Git)</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="auto-update-toggle">
                    <label class="form-check-label text-white-50" for="auto-update-toggle">Включить</label>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="update-status-indicator me-3" id="update-indicator"></div>
                    <div>
                        <div class="fw-bold" id="update-status-text">Загрузка статуса...</div>
                        <small class="text-white-50">Последняя проверка: <span
                                id="last-update-check">Никогда</span></small>
                    </div>
                </div>
                <p class="text-white-50 small mb-0">
                    <i class="bi bi-info-circle"></i> Когда функция включена, проект будет каждый час проверять наличие
                    обновлений в Git-репозитории. Если изменения будут найдены, они применятся автоматически, и сервер
                    перезагрузится.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .update-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6c757d;
        box-shadow: 0 0 10px rgba(108, 117, 125, 0.5);
    }

    .update-status-indicator.active {
        background: #00f2fe;
        box-shadow: 0 0 15px rgba(0, 242, 254, 0.8);
        animation: pulse-cyan 2s infinite;
    }

    @keyframes pulse-cyan {
        0% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.2);
            opacity: 0.7;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<div class="row mt-4">
    <div class="col-12">
        <div class="main-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Информация о системе</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <p><strong>Порт веб-интерфейса:</strong><br>3454</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Режим запуска:</strong><br>Development</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Парсер:</strong><br>Ozon Production Final</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .schedule-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .schedule-item .form-label {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .schedule-item .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    .days-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .day-checkbox {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
</style>

<script>
    let schedules = [];
    let scheduleIdCounter = 1;

    // Load saved schedules from backend
    function loadSchedules() {
        fetch('/api/schedules')
            .then(r => r.json())
            .then(data => {
                schedules = data;
                if (schedules.length > 0) {
                    scheduleIdCounter = Math.max(...schedules.map(s => s.id), 0) + 1;
                }
                renderSchedules();
                loadSchedulerStatus();
            })
            .catch(err => {
                console.error('Error loading schedules:', err);
                schedules = [];
                renderSchedules();
            });
    }

    // Load scheduler status
    function loadSchedulerStatus() {
        fetch('/api/schedules/status')
            .then(r => r.json())
            .then(data => {
                if (data.jobs && data.jobs.length > 0) {
                    const statusHtml = '<div class="alert"><i class="bi bi-clock"></i> <strong>Активных задач:</strong> ' + data.jobs.length +
                        '<ul class="mt-2 mb-0">' + data.jobs.map(j => '<li>' + j.name + ' - следующий запуск: ' + j.next_run + '</li>').join('') + '</ul></div>';
                    document.getElementById('schedule-status').innerHTML = statusHtml;
                } else {
                    document.getElementById('schedule-status').innerHTML = '<div class="alert"><i class="bi bi-info-circle"></i> Нет активных задач расписания.</div>';
                }
            })
            .catch(err => console.error('Error loading status:', err));
    }

    // Render all schedules
    function renderSchedules() {
        const container = document.getElementById('schedules-list');
        if (schedules.length === 0) {
            container.innerHTML = '<p class="text-white-50 text-center">Нет настроенных расписаний. Нажмите "Добавить расписание"</p>';
            return;
        }

        container.innerHTML = schedules.map(schedule => `
        <div class="schedule-item" data-id="${schedule.id}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Расписание #${schedule.id} (${schedule.platform ? schedule.platform.toUpperCase() : 'OZON'})</h6>
                <button class="btn btn-danger btn-sm" onclick="removeSchedule(${schedule.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            
            <div class="row g-2 mb-2">
                <div class="col-md-6">
                    <label class="form-label">Платформа</label>
                    <select class="form-select form-select-sm" onchange="updateSchedule(${schedule.id}, 'platform', this.value)">
                        <option value="ozon" ${schedule.platform === 'ozon' || !schedule.platform ? 'selected' : ''}>OZON</option>
                        <option value="wb" ${schedule.platform === 'wb' ? 'selected' : ''}>Wildberries</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Активно</label>
                    <select class="form-select form-select-sm" onchange="updateSchedule(${schedule.id}, 'enabled', this.value)">
                        <option value="false" ${!schedule.enabled ? 'selected' : ''}>Отключено</option>
                        <option value="true" ${schedule.enabled ? 'selected' : ''}>Включено</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-2">
                <label class="form-label">Время запуска</label>
                <input type="time" class="form-control form-control-sm" value="${schedule.time}" 
                       onchange="updateSchedule(${schedule.id}, 'time', this.value)">
            </div>
            
            <div class="mb-2">
                <label class="form-label">Дни недели</label>
                <div class="days-checkboxes">
                    ${['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].map((day, i) => `
                        <div class="day-checkbox">
                            <input type="checkbox" class="form-check-input" id="day-${schedule.id}-${i}" 
                                   ${schedule.days.includes(i) ? 'checked' : ''}
                                   onchange="updateScheduleDays(${schedule.id})">
                            <label class="form-check-label" for="day-${schedule.id}-${i}">${day}</label>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');
    }

    // Add new schedule
    document.getElementById('add-schedule-btn').addEventListener('click', () => {
        schedules.push({
            id: scheduleIdCounter++,
            platform: 'ozon',
            enabled: false,
            time: '03:00',
            days: [1, 2, 3, 4, 5] // Mon-Fri
        });
        renderSchedules();
    });

    // Remove schedule
    function removeSchedule(id) {
        if (confirm('Удалить это расписание?')) {
            schedules = schedules.filter(s => s.id !== id);
            renderSchedules();
        }
    }

    // Update schedule field
    function updateSchedule(id, field, value) {
        const schedule = schedules.find(s => s.id === id);
        if (schedule) {
            schedule[field] = field === 'enabled' ? value === 'true' : value;
        }
    }

    // Update schedule days
    function updateScheduleDays(id) {
        const schedule = schedules.find(s => s.id === id);
        if (schedule) {
            schedule.days = [];
            for (let i = 0; i < 7; i++) {
                const checkbox = document.getElementById(`day-${id}-${i}`);
                if (checkbox && checkbox.checked) {
                    schedule.days.push(i);
                }
            }
        }
    }

    // Save all schedules to backend
    document.getElementById('save-schedules-btn').addEventListener('click', function () {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Сохранение...';

        fetch('/api/schedules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(schedules)
        })
            .then(r => r.json())
            .then(data => {
                const statusDiv = document.getElementById('schedule-status');
                if (data.status === 'success') {
                    statusDiv.innerHTML = '<div class="alert"><i class="bi bi-check-circle"></i> ' + data.message + '</div>';
                    loadSchedulerStatus(); // Reload status to show next run times
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ' + data.message + '</div>';
                }
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить все расписания';
            })
            .catch(err => {
                document.getElementById('schedule-status').innerHTML = '<div class="alert alert-danger">Ошибка: ' + err + '</div>';
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Сохранить все расписания';
            });
    });

    // Load all config from server
    function loadConfig() {
        fetch('/api/config')
            .then(r => r.json())
            .then(data => {
                if (data.ozon_spreadsheet_url) document.getElementById('google-sheet-url').value = data.ozon_spreadsheet_url;
                if (data.wb_spreadsheet_url) document.getElementById('google-sheet-url-wb').value = data.wb_spreadsheet_url;
            });

        fetch('/api/system/settings')
            .then(r => r.json())
            .then(data => {
                document.getElementById('sys-db-host').value = data.db_host || '';
                document.getElementById('sys-db-port').value = data.db_port || '';
                document.getElementById('sys-db-name').value = data.db_name || '';
                document.getElementById('sys-db-user').value = data.db_user || '';
                document.getElementById('sys-chrome-path').value = data.chrome_path || '';
                document.getElementById('sys-flask-key').value = data.flask_secret_key || '';
            });

        fetch('/api/system/update/status')
            .then(r => r.json())
            .then(data => {
                const toggle = document.getElementById('auto-update-toggle');
                const indicator = document.getElementById('update-indicator');
                const text = document.getElementById('update-status-text');
                const lastCheck = document.getElementById('last-update-check');

                toggle.checked = data.auto_update;
                lastCheck.innerText = data.last_check;

                if (data.auto_update) {
                    indicator.classList.add('active');
                    text.innerText = 'Автообновление активно (каждый час)';
                } else {
                    indicator.classList.remove('active');
                    text.innerText = 'Автообновление выключено';
                }
            });

        fetch('/api/telegram/settings')
            .then(r => r.json())
            .then(data => {
                if (data.bot_token) document.getElementById('telegram-bot-token').value = data.bot_token;
                if (data.chat_id) document.getElementById('telegram-chat-id').value = data.chat_id;
            });
    }

    // System Settings - Save
    document.getElementById('save-system-settings-btn').addEventListener('click', function () {
        const payload = {
            db_host: document.getElementById('sys-db-host').value,
            db_port: document.getElementById('sys-db-port').value,
            db_name: document.getElementById('sys-db-name').value,
            db_user: document.getElementById('sys-db-user').value,
            chrome_path: document.getElementById('sys-chrome-path').value,
            flask_secret_key: document.getElementById('sys-flask-key').value
        };
        const pass = document.getElementById('sys-db-pass').value;
        if (pass) payload.db_pass = pass;

        this.disabled = true;
        fetch('/api/system/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(data => {
                document.getElementById('system-status').innerHTML = `<div class="alert ${data.status === 'success' ? '' : 'alert-danger'}">${data.message}</div>`;
                this.disabled = false;
            });
    });

    // Auto-update Toggle
    document.getElementById('auto-update-toggle').addEventListener('change', function () {
        const enabled = this.checked;
        fetch('/api/system/update/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: enabled })
        })
            .then(r => r.json())
            .then(data => {
                const indicator = document.getElementById('update-indicator');
                const text = document.getElementById('update-status-text');
                if (enabled) {
                    indicator.classList.add('active');
                    text.innerText = 'Автообновление активно (каждый час)';
                } else {
                    indicator.classList.remove('active');
                    text.innerText = 'Автообновление выключено';
                }
            });
    });

    // Save Google Sheet URL (OZON)
    document.getElementById('save-sheet-url-btn').addEventListener('click', function () {
        const url = document.getElementById('google-sheet-url').value;
        this.disabled = true;
        fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ozon_spreadsheet_url: url })
        })
            .then(r => r.json())
            .then(data => {
                document.getElementById('db-status').innerHTML = `<div class="alert">${data.message}</div>`;
                this.disabled = false;
            });
    });

    // Save Google Sheet URL (WB)
    document.getElementById('save-sheet-url-wb-btn').addEventListener('click', function () {
        const url = document.getElementById('google-sheet-url-wb').value;
        this.disabled = true;
        fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wb_spreadsheet_url: url })
        })
            .then(r => r.json())
            .then(data => {
                document.getElementById('db-status-wb').innerHTML = `<div class="alert">${data.message}</div>`;
                this.disabled = false;
            });
    });

    // Update Database (OZON)
    document.getElementById('update-db-btn').addEventListener('click', function () {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Запуск...';
        fetch('/api/database/update', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('db-status').innerHTML = `<div class="alert ${data.status === 'success' ? '' : 'alert-danger'}">${data.message}</div>`;
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Импортировать OZON';
            });
    });

    // Update Database (WB)
    document.getElementById('update-db-wb-btn').addEventListener('click', function () {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Запуск...';
        fetch('/api/database/update_wb', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('db-status-wb').innerHTML = `<div class="alert ${data.status === 'success' ? '' : 'alert-danger'}">${data.message}</div>`;
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Импортировать WB';
            });
    });

    // Telegram Settings - Save
    document.getElementById('save-telegram-settings-btn').addEventListener('click', function () {
        const payload = {
            bot_token: document.getElementById('telegram-bot-token').value,
            chat_id: document.getElementById('telegram-chat-id').value
        };
        this.disabled = true;
        fetch('/api/telegram/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(data => {
                document.getElementById('tg-status').innerHTML = `<div class="alert ${data.status === 'success' ? '' : 'alert-danger'}">${data.message}</div>`;
                this.disabled = false;
            });
    });

    // System Settings - Test DB
    document.getElementById('test-db-connection-btn').addEventListener('click', function () {
        const payload = {
            db_host: document.getElementById('sys-db-host').value,
            db_port: document.getElementById('sys-db-port').value,
            db_name: document.getElementById('sys-db-name').value,
            db_user: document.getElementById('sys-db-user').value,
            db_pass: document.getElementById('sys-db-pass').value
        };

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Проверка...';

        fetch('/api/database/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(data => {
                document.getElementById('system-status').innerHTML = `<div class="alert ${data.status === 'success' ? '' : 'alert-danger'}">${data.message}</div>`;
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-database-check"></i> Проверить БД';
            });
    });

    // Key generation
    document.getElementById('generate-key-btn').addEventListener('click', () => {
        const chars = 'abcdef0123456789';
        let key = '';
        for (let i = 0; i < 64; i++) key += chars[Math.floor(Math.random() * chars.length)];
        document.getElementById('sys-flask-key').value = key;
    });

    // Load data on page load
    loadSchedules();
    loadConfig();
</script>
{% endblock %}