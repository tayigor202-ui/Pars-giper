{% extends "base.html" %}

{% block title %}Дашборд - Analytics{% endblock %}

{% block content %}
<div class="row align-items-end mb-4">
    <div class="col-lg-8">
        <h1 class="page-title">Дашборд</h1>
        <p class="page-subtitle">Обзор производительности и детальная аналитика.</p>
    </div>
    <div class="col-lg-4 text-lg-end mb-3">
        <div class="btn-group p-1" style="background: rgba(255,255,255,0.05); border-radius: 14px;">
            <input type="radio" class="btn-check" name="platform-toggle" id="ozon-btn" checked>
            <label class="btn btn-sm px-4 rounded-3 text-white border-0" for="ozon-btn">Ozon</label>

            <input type="radio" class="btn-check" name="platform-toggle" id="wb-btn">
            <label class="btn btn-sm px-4 rounded-3 text-white border-0" for="wb-btn">WB</label>
        </div>
    </div>
</div>

<!-- Stats row -->
<div class="row g-4 mb-5">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">Товары</div>
            <div class="stat-value" id="total-products">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">С ценами</div>
            <div class="stat-value" id="products-with-prices">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left: 2px solid var(--brand-secondary);">
            <div class="stat-label">Средняя цена</div>
            <div class="stat-value" id="avg-price">0 ₽</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">Магазины</div>
            <div class="stat-value" id="total-stores">0</div>
        </div>
    </div>
</div>

<!-- Chart row -->
<div class="row mb-5">
    <div class="col-12">
        <div class="main-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="h5 mb-0 fw-bold">ТОП Магазинов по средней цене</h3>
                <span class="badge bg-white bg-opacity-10 text-white-50 px-3 py-2 rounded-pill">Real-time</span>
            </div>
            <div style="height: 300px; position: relative;">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Table container -->
<div class="row">
    <div class="col-12">
        <div class="main-card">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                <h3 class="h5 mb-0 fw-bold">Товары и цены</h3>
                <button id="export-excel-btn" class="btn btn-action btn-sm px-4">
                    <i class="bi bi-file-earmark-excel me-2"></i> Экспорт в Excel
                </button>
            </div>

            <!-- Filter Panel -->
            <div class="row g-3 mb-4 p-3 rounded-4" style="background: rgba(0,0,0,0.2);">
                <div class="col-md-4">
                    <label class="form-label small text-secondary fw-bold">ПОИСК</label>
                    <input type="text" id="filter-search" class="form-control form-control-sm"
                        placeholder="Наименование или SKU...">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-secondary fw-bold">МАГАЗИН</label>
                    <select id="filter-store" class="form-select form-select-sm">
                        <option value="">Все магазины</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-secondary fw-bold">ДИАПАЗОН ЦЕН</label>
                    <div class="input-group input-group-sm">
                        <input type="number" id="filter-min-price" class="form-control" placeholder="От">
                        <input type="number" id="filter-max-price" class="form-control" placeholder="До">
                    </div>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button id="apply-filters-btn" class="btn btn-action btn-sm w-100 py-2">
                        <i class="bi bi-filter"></i>
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table text-white border-0">
                    <thead>
                        <tr id="table-headers">
                            <th class="ps-4"><i class="bi bi-hash me-2"></i>SKU</th>
                            <th><i class="bi bi-alphabet-uppercase me-2"></i>Название</th>
                            <th><i class="bi bi-shop me-2"></i>Продавец</th>
                            <th id="col-promo"><i class="bi bi-tag-fill me-2 text-info"></i>Цена с картой</th>
                            <th id="col-price"><i class="bi bi-wallet2 me-2 text-white-50"></i>Цена без карты</th>
                            <th id="col-old"><i class="bi bi-percent me-2 text-danger"></i>Старая цена</th>
                            <th class="pe-4 text-end"><i class="bi bi-clock-history me-2"></i>Обновлено</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <!-- Data rows here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-secondary small">Страница <span id="current-page-num">1</span> из <span
                        id="total-pages-num">1</span></div>
                <div class="btn-group">
                    <button id="prev-page-btn"
                        class="btn btn-outline-light btn-sm px-3 rounded-start-pill border-opacity-25"
                        disabled>Назад</button>
                    <button id="next-page-btn"
                        class="btn btn-outline-light btn-sm px-3 rounded-end-pill border-opacity-25"
                        disabled>Вперед</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let currentPlatform = 'ozon';
    let currentPage = 1;
    const brandColor = '#6366f1';

    function updateHeaders() {
        if (currentPlatform === 'wb') {
            document.getElementById('col-promo').innerText = 'Промо';
            document.getElementById('col-price').innerText = 'Цена';
            document.getElementById('col-old').innerText = 'Старая';
        } else {
            document.getElementById('col-promo').innerText = 'Цена с картой';
            document.getElementById('col-price').innerText = 'Цена без карты';
            document.getElementById('col-old').innerText = 'Старая цена';
        }
    }

    function updateHeaders() {
        if (currentPlatform === 'wb') {
            document.getElementById('col-promo').innerText = 'Промо';
            document.getElementById('col-price').innerText = 'Цена';
            document.getElementById('col-old').innerText = 'Старая';
        } else {
            document.getElementById('col-promo').innerText = 'Цена с картой';
            document.getElementById('col-price').innerText = 'Цена без карты';
            document.getElementById('col-old').innerText = 'Старая цена';
        }
    }

    // Core Stats
    function loadStats() {
        fetch(`/api/dashboard/stats?platform=${currentPlatform}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('total-products').innerText = data.total_products || 0;
                document.getElementById('products-with-prices').innerText = data.products_with_prices || 0;
                document.getElementById('avg-price').innerText = (data.avg_price ? Math.round(data.avg_price).toLocaleString('ru-RU') : 0) + ' ₽';
                document.getElementById('total-stores').innerText = data.total_stores || 0;
            });
    }

    // Chart
    const ctx = document.getElementById('priceChart');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['...'],
            datasets: [{
                label: 'Средняя цена',
                data: [0],
                backgroundColor: brandColor,
                borderRadius: 8,
                barThickness: 20,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#64748b' },
                    beginAtZero: true,
                    grace: '10%' // Add padding at the top of the chart
                },
                x: { grid: { display: false }, ticks: { color: '#64748b' } }
            }
        }
    });

    function loadChart() {
        fetch(`/api/dashboard/chart?platform=${currentPlatform}`)
            .then(r => r.json())
            .then(data => {
                chart.data.labels = data.labels;
                chart.data.datasets[0].data = data.data;
                chart.update();
            });
    }

    // Table and Filters
    function loadTable() {
        updateHeaders();
        const search = document.getElementById('filter-search').value;
        const store = document.getElementById('filter-store').value;
        const minPrice = document.getElementById('filter-min-price').value;
        const maxPrice = document.getElementById('filter-max-price').value;

        const url = `/api/dashboard/table?platform=${currentPlatform}&page=${currentPage}&search=${encodeURIComponent(search)}&store=${encodeURIComponent(store)}&min_price=${minPrice}&max_price=${maxPrice}`;

        const tbody = document.getElementById('products-table-body');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-secondary"><div class="spinner-border spinner-border-sm me-2"></div> Загрузка...</td></tr>';

        fetch(url)
            .then(r => r.json())
            .then(data => {
                console.log("Dashboard data:", data);
                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger">Ошибка API: ${data.error}</td></tr>`;
                    return;
                }

                const storeSelect = document.getElementById('filter-store');
                if (data.stores) {
                    const currentStore = storeSelect.value;
                    storeSelect.innerHTML = '<option value="">Все магазины</option>';
                    data.stores.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s || '';
                        opt.innerText = s || '---';
                        storeSelect.appendChild(opt);
                    });
                    storeSelect.value = currentStore;
                }

                tbody.innerHTML = '';
                if (!data.items || data.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">Данные не найдены</td></tr>';
                } else {
                    data.items.forEach((item, index) => {
                        try {
                            const sku = item.sku || '---';
                            const name = item.name || '---';
                            const seller = item.seller || '---';
                            const promo = item.promo || '---';
                            const price = item.price || '---';
                            const old = item.old || '';
                            const updated = item.updated || '---';

                            const isSpecial = String(price).length > 10;

                            // Style for seller badge based on platform
                            let sellerClass = currentPlatform === 'wb' ? 'badge-wb' : 'badge-ozon';

                            tbody.innerHTML += `
                                <tr style="animation: fadeInUp 0.4s ease forwards ${index * 0.05}s; opacity: 0;">
                                    <td class="ps-4"><span class="sku-pill">${sku}</span></td>
                                    <td class="fw-semibold text-white-50 name-cell">${name}</td>
                                    <td><span class="seller-badge ${sellerClass}">${seller}</span></td>
                                    <td class="fw-bold price-primary ${isSpecial ? 'text-warning' : ''}">${promo}</td>
                                    <td class="fw-bold price-secondary ${isSpecial ? 'text-warning' : ''}">${price}</td>
                                    <td class="text-secondary text-decoration-line-through small opacity-50">${old}</td>
                                    <td class="pe-4 text-end text-secondary small font-monospace">${updated}</td>
                                </tr>
                            `;
                        } catch (e) {
                            console.error(`Error rendering row ${index}:`, e, item);
                        }
                    });
                }

                document.getElementById('current-page-num').innerText = data.current_page || 1;
                document.getElementById('total-pages-num').innerText = data.total_pages || 1;
                document.getElementById('prev-page-btn').disabled = (data.current_page || 1) <= 1;
                document.getElementById('next-page-btn').disabled = (data.current_page || 1) >= (data.total_pages || 1);
            })
            .catch(err => {
                console.error("Fetch error:", err);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger">Сбой сети или сервера: ${err.message}</td></tr>`;
            });
    }

    // Handlers
    document.getElementById('ozon-btn').addEventListener('change', () => {
        currentPlatform = 'ozon';
        document.getElementById('filter-store').innerHTML = '<option value="">Все магазины</option>';
        currentPage = 1;
        loadStats(); loadChart(); loadTable();
    });
    document.getElementById('wb-btn').addEventListener('change', () => {
        currentPlatform = 'wb';
        document.getElementById('filter-store').innerHTML = '<option value="">Все магазины</option>';
        currentPage = 1;
        loadStats(); loadChart(); loadTable();
    });

    document.getElementById('apply-filters-btn').addEventListener('click', () => { currentPage = 1; loadTable(); });
    document.getElementById('prev-page-btn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; loadTable(); } });
    document.getElementById('next-page-btn').addEventListener('click', () => { currentPage++; loadTable(); });

    document.getElementById('export-excel-btn').addEventListener('click', () => {
        const search = document.getElementById('filter-search').value;
        const store = document.getElementById('filter-store').value;
        const minPrice = document.getElementById('filter-min-price').value;
        const maxPrice = document.getElementById('filter-max-price').value;

        const url = `/api/dashboard/export?platform=${currentPlatform}&search=${encodeURIComponent(search)}&store=${encodeURIComponent(store)}&min_price=${minPrice}&max_price=${maxPrice}`;
        window.location.href = url;
    });

    // Initial load
    loadStats();
    loadChart();
    loadTable();
</script>
<style>
    .btn-check:checked+label {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)) !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .form-control-sm,
    .form-select-sm {
        font-size: 0.85rem;
    }

    #table-headers th {
        background: rgba(15, 16, 22, 0.8);
        backdrop-filter: blur(10px);
        border-bottom: 2px solid rgba(255, 255, 255, 0.05);
        padding: 18px 10px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #64748b;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    #products-table-body tr {
        transition: var(--transition-smooth);
        border-bottom: 1px solid rgba(255, 255, 255, 0.02);
    }

    #products-table-body tr:hover {
        background: rgba(255, 255, 255, 0.03) !important;
        transform: scale(1.002) translateX(5px);
        box-shadow: inset 4px 0 0 var(--brand-primary);
    }

    .sku-pill {
        background: rgba(255, 255, 255, 0.05);
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.8rem;
        color: #94a3b8;
        font-family: 'Outfit', sans-serif;
    }

    .name-cell {
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .seller-badge {
        padding: 6px 12px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .badge-ozon {
        background: rgba(0, 91, 255, 0.1);
        color: #60a5fa;
        border-color: rgba(0, 91, 255, 0.2);
    }

    .badge-wb {
        background: rgba(168, 85, 247, 0.1);
        color: #c084fc;
        border-color: rgba(168, 85, 247, 0.2);
    }

    .price-primary {
        color: #22d3ee;
        font-size: 1.05rem;
    }

    .price-secondary {
        color: #f8fafc;
        font-size: 0.95rem;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}