{% extends "base.html" %}

{% block title %}Дашборд - OZON Parser{% endblock %}

{% block content %}
<div class="row mb-4 reveal">
    <div class="col-md-8">
        <h1 class="page-title"><i class="bi bi-speedometer2 text-neon-cyan"></i> Дашборд мониторинга</h1>
        <p class="page-subtitle">Реал-тайм обзор состояния парсинга и цен</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group reveal" style="animation-delay:0.1s" role="group">
            <input type="radio" class="btn-check" name="platform-toggle" id="ozon-btn" autocomplete="off" checked>
            <label class="btn btn-outline-info px-4 border-2" for="ozon-btn">OZON</label>

            <input type="radio" class="btn-check" name="platform-toggle" id="wb-btn" autocomplete="off">
            <label class="btn btn-outline-info px-4 border-2" for="wb-btn">Wildberries</label>
        </div>
    </div>
</div>

<div class="row g-4 mb-5 reveal" style="animation-delay:0.2s">
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-label">Всего товаров</div>
            <div class="stat-value neon-glow-cyan" id="total-products">—</div>
            <i class="bi bi-cpu stat-icon neon-glow-cyan"></i>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-label">С ценами</div>
            <div class="stat-value neon-glow-cyan" id="products-with-prices">—</div>
            <i class="bi bi-shield-check stat-icon neon-glow-cyan"></i>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-label">Средняя цена</div>
            <div class="stat-value neon-glow-purple" id="avg-price">—</div>
            <i class="bi bi-lightning-charge stat-icon neon-glow-purple"></i>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-label">Источники</div>
            <div class="stat-value neon-glow-cyan" id="total-stores">—</div>
            <i class="bi bi-database-check stat-icon neon-glow-cyan"></i>
        </div>
    </div>
</div>

<div class="row reveal" style="animation-delay:0.3s">
    <div class="col-12">
        <div class="main-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0 fw-bold"><i class="bi bi-activity neon-glow-cyan"></i> Аналитическая разведка цен</h4>
                <div class="badge bg-primary-subtle text-primary border border-primary-subtle px-4 py-2 rounded-pill">
                    DATA SYNCHRONIZED</div>
            </div>
            <div class="card-body">
                <canvas id="priceChart" style="height: 450px;"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let currentPlatform = 'ozon';

    // Load dashboard stats
    function loadStats() {
        fetch(`/api/dashboard/stats?platform=${currentPlatform}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-products').textContent = data.total_products || 0;
                document.getElementById('products-with-prices').textContent = data.products_with_prices || 0;
                document.getElementById('avg-price').textContent = data.avg_price ? Math.round(data.avg_price) + ' ₽' : '0 ₽';
                document.getElementById('total-stores').textContent = data.total_stores || 0;
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
    }

    // Initialize chart
    const ctx = document.getElementById('priceChart');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Загрузка...'],
            datasets: [{
                label: 'Средняя цена (₽)',
                data: [0],
                backgroundColor: (context) => {
                    const chart = context.chart;
                    const { ctx, chartArea } = chart;
                    if (!chartArea) return null;
                    const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                    gradient.addColorStop(0, 'rgba(112, 0, 255, 0.1)');
                    gradient.addColorStop(0.5, 'rgba(0, 210, 255, 0.4)');
                    gradient.addColorStop(1, 'rgba(0, 210, 255, 0.9)');
                    return gradient;
                },
                borderColor: '#00d2ff',
                borderWidth: 1,
                borderRadius: 20,
                hoverBackgroundColor: 'rgba(0, 210, 255, 1)',
                hoverBorderColor: '#fff',
                hoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(10, 10, 12, 0.9)',
                    titleFont: { size: 16, weight: 'bold' },
                    bodyFont: { size: 14 },
                    padding: 15,
                    cornerRadius: 12,
                    displayColors: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'rgba(255,255,255,0.6)', font: { family: 'Inter' }, callback: value => value + ' ₽' },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                x: {
                    ticks: { color: 'rgba(255,255,255,0.6)', font: { family: 'Inter' } },
                    grid: { display: false }
                }
            }
        }
    });

    // Load chart data
    function loadChart() {
        fetch(`/api/dashboard/chart?platform=${currentPlatform}`)
            .then(response => response.json())
            .then(data => {
                if (data.labels && data.labels.length > 0) {
                    chart.data.labels = data.labels;
                    chart.data.datasets[0].data = data.data;
                } else {
                    chart.data.labels = ['Нет данных'];
                    chart.data.datasets[0].data = [0];
                }
                chart.update();
            })
            .catch(error => console.error('Error loading chart:', error));
    }

    // Platform toggle listeners
    document.getElementById('ozon-btn').addEventListener('change', function () {
        if (this.checked) {
            currentPlatform = 'ozon';
            loadStats();
            loadChart();
        }
    });

    document.getElementById('wb-btn').addEventListener('change', function () {
        if (this.checked) {
            currentPlatform = 'wb';
            loadStats();
            loadChart();
        }
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadChart();
    });
</script>
{% endblock %}