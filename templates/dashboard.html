{% extends "base.html" %}

{% block title %}Дашборд - Analytics{% endblock %}

{% block content %}
<div class="row align-items-end mb-4">
    <div class="col-lg-8">
        <h1 class="page-title">Дашборд</h1>
        <p class="page-subtitle">Обзор производительности и детальная аналитика.</p>
    </div>
    <div class="col-lg-4 text-lg-end mb-3">
        <div class="btn-group p-1" style="background: rgba(255,255,255,0.05); border-radius: 14px;">
            <input type="radio" class="btn-check" name="platform-toggle" id="ozon-btn" checked>
            <label class="btn btn-sm px-4 rounded-3 text-white border-0" for="ozon-btn">Ozon</label>

            <input type="radio" class="btn-check" name="platform-toggle" id="wb-btn">
            <label class="btn btn-sm px-4 rounded-3 text-white border-0" for="wb-btn">WB</label>
        </div>
    </div>
</div>

<!-- Stats row -->
<div class="row g-4 mb-5">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">Товары</div>
            <div class="stat-value" id="total-products">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">С ценами</div>
            <div class="stat-value" id="products-with-prices">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left: 2px solid var(--brand-secondary);">
            <div class="stat-label">Средняя цена</div>
            <div class="stat-value" id="avg-price">0 ₽</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">Магазины</div>
            <div class="stat-value" id="total-stores">0</div>
        </div>
    </div>
</div>

<!-- Chart row -->
<div class="row mb-5">
    <div class="col-12">
        <div class="main-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="h5 mb-0 fw-bold">ТОП Магазинов по средней цене</h3>
                <span class="badge bg-white bg-opacity-10 text-white-50 px-3 py-2 rounded-pill">Real-time</span>
            </div>
            <div style="height: 300px; position: relative;">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Table container -->
<div class="row">
    <div class="col-12">
        <div class="main-card">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                <div class="d-flex align-items-center gap-3">
                    <h3 class="h5 mb-0 fw-bold">Товары и цены</h3>
                    <div class="btn-group ms-2">
                        <button class="btn btn-outline-light btn-sm px-3 rounded-pill border-opacity-25 active"
                            id="view-list-btn" onclick="setView('list')">
                            <i class="bi bi-list-ul"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm px-3 rounded-pill border-opacity-25 ms-1"
                            id="view-matrix-btn" onclick="setView('matrix')">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </button>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-light btn-sm px-3 rounded-pill border-opacity-25" type="button"
                        data-bs-toggle="offcanvas" data-bs-target="#offcanvasFilters">
                        <i class="bi bi-sliders2 me-2"></i> Фильтры
                    </button>
                    <button id="export-excel-btn" class="btn btn-action btn-sm px-4">
                        <i class="bi bi-file-earmark-excel me-2"></i> Экспорт в Excel
                    </button>
                </div>
            </div>

            <!-- Table Container with fixed height -->
            <div id="table-scroll-container" class="table-responsive rounded-4"
                style="background: #0f1016; border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 65vh; overflow: auto;">
                <table class="table border-0 mb-0" id="main-data-table"
                    style="--bs-table-bg: transparent; --bs-table-color: white; border-collapse: separate; border-spacing: 0;">
                    <thead style="position: sticky; top: 0; z-index: 20;">
                        <tr id="table-headers" style="background: #0a0b10;">
                            <th class="ps-4">SKU</th>
                            <th>Название</th>
                            <th>Продавец</th>
                            <th>Цена с картой</th>
                            <th>Цена без карты</th>
                            <th>Старая цена</th>
                            <th class="pe-4 text-end">Обновлено</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <!-- Data rows here -->
                    </tbody>
                </table>
                <div id="table-loader" class="text-center py-4 d-none">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    <span class="text-secondary small">Загрузка данных...</span>
                </div>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-secondary small">Страница <span id="current-page-num">1</span> из <span
                        id="total-pages-num">1</span></div>
                <div class="btn-group">
                    <button id="prev-page-btn"
                        class="btn btn-outline-light btn-sm px-3 rounded-start-pill border-opacity-25"
                        disabled>Назад</button>
                    <button id="next-page-btn"
                        class="btn btn-outline-light btn-sm px-3 rounded-end-pill border-opacity-25"
                        disabled>Вперед</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar Filters (Offcanvas) -->
<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="offcanvasFilters"
    style="background: #16171d; width: 350px;">
    <div class="offcanvas-header border-bottom border-white border-opacity-10 py-4">
        <h5 class="offcanvas-title fw-bold text-white"><i class="bi bi-sliders2 me-2 text-primary"></i>Фильтры</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-4">
        <div class="mb-4">
            <label class="form-label small text-secondary fw-bold mb-2">ПОИСК</label>
            <input type="text" id="filter-search" class="form-control" placeholder="Наименование или SKU...">
        </div>
        <div class="mb-4">
            <label class="form-label small text-secondary fw-bold mb-2">МАГАЗИН</label>
            <select id="filter-store" class="form-select">
                <option value="">Все магазины</option>
            </select>
        </div>
        <div class="mb-4">
            <label class="form-label small text-secondary fw-bold mb-2">ОТ ЦЕНЫ</label>
            <input type="number" id="filter-min-price" class="form-control" placeholder="0 ₽">
        </div>
        <div class="mb-4">
            <label class="form-label small text-secondary fw-bold mb-2">ДО ЦЕНЫ</label>
            <input type="number" id="filter-max-price" class="form-control" placeholder="999 999 ₽">
        </div>
        <button id="apply-filters-btn" class="btn btn-action w-100 py-3 mt-3" data-bs-dismiss="offcanvas">
            Применить фильтры
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let currentPlatform = 'ozon';
    let currentPage = 1;
    let totalPages = 1;
    let currentView = 'list';
    let isLoading = false;
    const brandColor = '#6366f1';

    function setView(view) {
        if (currentView === view) return;
        currentView = view;

        // UI Updates
        document.getElementById('view-list-btn').classList.toggle('active', view === 'list');
        document.getElementById('view-matrix-btn').classList.toggle('active', view === 'matrix');

        // Set container class for sticky CSS
        const container = document.getElementById('table-scroll-container');
        container.classList.toggle('view-matrix', view === 'matrix');
        container.classList.toggle('view-list', view === 'list');

        // Reset and reload
        currentPage = 1;
        document.getElementById('products-table-body').innerHTML = '';
        loadTable();
    }

    // Core Stats
    function loadStats() {
        fetch(`/api/dashboard/stats?platform=${currentPlatform}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('total-products').innerText = data.total_products || 0;
                document.getElementById('products-with-prices').innerText = data.products_with_prices || 0;
                document.getElementById('avg-price').innerText = (data.avg_price ? Math.round(data.avg_price).toLocaleString('ru-RU') : 0) + ' ₽';
                document.getElementById('total-stores').innerText = data.total_stores || 0;
            });
    }

    // Chart
    const ctx = document.getElementById('priceChart');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['...'],
            datasets: [{
                label: 'Средняя цена',
                data: [0],
                backgroundColor: brandColor,
                borderRadius: 8,
                barThickness: 20,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#64748b' },
                    beginAtZero: true,
                    grace: '10%'
                },
                x: { grid: { display: false }, ticks: { color: '#64748b' } }
            }
        }
    });

    function loadChart() {
        fetch(`/api/dashboard/chart?platform=${currentPlatform}`)
            .then(r => r.json())
            .then(data => {
                chart.data.labels = data.labels;
                chart.data.datasets[0].data = data.data;
                chart.update();
            });
    }

    // Table and Infinite Scroll
    function loadTable(append = false) {
        if (isLoading) return;
        isLoading = true;

        const platform = currentPlatform;
        const search = document.getElementById('filter-search').value;
        const store = document.getElementById('filter-store').value;
        const min_price = document.getElementById('filter-min-price').value;
        const max_price = document.getElementById('filter-max-price').value;

        const loader = document.getElementById('table-loader');
        loader.classList.remove('d-none');

        const url = `/api/dashboard/items?platform=${platform}&page=${currentPage}&search=${encodeURIComponent(search)}&store=${encodeURIComponent(store)}&min_price=${min_price}&max_price=${max_price}`;

        const tbody = document.getElementById('products-table-body');
        if (!append) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-secondary"><div class="spinner-border spinner-border-sm me-2"></div> Загрузка...</td></tr>';
            document.getElementById('table-scroll-container').scrollTop = 0;
        }

        fetch(url)
            .then(res => res.json())
            .then(data => {
                isLoading = false;
                loader.classList.add('d-none');

                if (data.error) {
                    if (!append) tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger">Ошибка API: ${data.error}</td></tr>`;
                    return;
                }

                totalPages = data.total_pages || 1;

                // Update filter stores if needed
                if (data.stores && document.getElementById('filter-store').options.length <= 1) {
                    const storeSelect = document.getElementById('filter-store');
                    data.stores.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s || '';
                        opt.innerText = s || '---';
                        storeSelect.appendChild(opt);
                    });
                }

                if (currentView === 'matrix') {
                    renderMatrixTable(data.items, append);
                } else {
                    renderListTable(data.items, append);
                }

                // Update pagination info
                document.getElementById('current-page-num').innerText = currentPage;
                document.getElementById('total-pages-num').innerText = totalPages;
            })
            .catch(err => {
                isLoading = false;
                loader.classList.add('d-none');
                console.error("Fetch error:", err);
                if (!append) tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger">Сбой сети: ${err.message}</td></tr>`;
            });
    }

    function renderListTable(items, append) {
        const thead = document.getElementById('table-headers');
        thead.innerHTML = `
            <th class="ps-4"><i class="bi bi-hash me-2"></i>SKU</th>
            <th><i class="bi bi-alphabet-uppercase me-2"></i>Название</th>
            <th><i class="bi bi-shop me-2"></i>Продавец</th>
            <th><i class="bi bi-tag-fill me-2 text-info"></i>${currentPlatform === 'wb' ? 'Промо' : 'Цена с картой'}</th>
            <th><i class="bi bi-wallet2 me-2 text-white-50"></i>${currentPlatform === 'wb' ? 'Цена' : 'Цена без карты'}</th>
            <th><i class="bi bi-percent me-2 text-danger"></i>${currentPlatform === 'wb' ? 'Старая' : 'Старая цена'}</th>
            <th class="pe-4 text-end"><i class="bi bi-clock-history me-2"></i>Обновлено</th>
        `;

        const tbody = document.getElementById('products-table-body');
        if (!append) tbody.innerHTML = '';

        if (items.length === 0 && !append) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">Данные не найдены</td></tr>';
            return;
        }

        items.forEach((item, index) => {
            const { sku, name, seller, promo, price, old, updated } = item;
            let sellerClass = currentPlatform === 'wb' ? 'badge-wb' : 'badge-ozon';
            if (seller && seller.toLowerCase().includes('холодильник')) sellerClass = 'badge-holod';

            const isSpecial = promo && promo !== '---' && !promo.includes('Ошибка') && !promo.includes('закончился');
            let discountBadge = '';
            try {
                const p = parseFloat(String(promo).replace(/[^\d]/g, ''));
                const o = parseFloat(String(old).replace(/[^\d]/g, ''));
                if (o > p && p > 0) {
                    const pct = Math.round((1 - p / o) * 100);
                    if (pct > 0) discountBadge = `<span class="discount-pill">-${pct}%</span>`;
                }
            } catch (e) { }

            tbody.innerHTML += `
                <tr style="animation: fadeInUp 0.4s ease forwards ${index * 0.05}s; opacity: 0;">
                    <td class="ps-4"><span class="sku-pill">${sku}</span></td>
                    <td class="fw-bold name-cell" title="${name}">${name}</td>
                    <td><span class="seller-badge ${sellerClass}">${seller}</span></td>
                    <td class="fw-bold price-primary ${isSpecial ? 'text-warning' : ''}">${promo} ${discountBadge}</td>
                    <td class="fw-bold price-secondary">${price}</td>
                    <td class="text-secondary text-decoration-line-through small opacity-50">${old}</td>
                    <td class="pe-4 text-end text-secondary small">${updated}</td>
                </tr>
            `;
        });
    }

    function renderMatrixTable(items, append) {
        // Group items by product
        const productsMap = {};
        items.forEach(item => {
            const key = `${item.sp_code}_${item.name}`;
            if (!productsMap[key]) {
                productsMap[key] = { name: item.name, sp_code: item.sp_code, sellers: {} };
            }
            productsMap[key].sellers[item.seller] = { promo: item.promo, sku: item.sku };
        });

        // Use stores present in current items
        const currentStores = Array.from(new Set(items.map(i => i.seller))).sort();

        const thead = document.getElementById('table-headers');
        thead.innerHTML = `
            <th class="ps-4">Наименование</th>
            <th>СП-КОД</th>
            ${currentStores.map(s => `<th>${s}</th>`).join('')}
        `;

        const tbody = document.getElementById('products-table-body');
        if (!append) tbody.innerHTML = '';

        if (Object.keys(productsMap).length === 0 && !append) {
            tbody.innerHTML = `<tr><td colspan="${currentStores.length + 2}" class="text-center py-4 text-secondary">Данные не найдены</td></tr>`;
            return;
        }

        Object.values(productsMap).forEach((product, index) => {
            let rowHtml = `
                <tr style="animation: fadeInUp 0.4s ease forwards ${index * 0.05}s; opacity: 0;">
                    <td class="ps-4 name-cell" style="max-width: 300px;" title="${product.name}">${product.name}</td>
                    <td><span class="sku-pill" style="color:#22d3ee; border-color: rgba(34,211,238,0.2);">${product.sp_code}</span></td>
            `;

            currentStores.forEach(store => {
                const info = product.sellers[store];
                if (info) {
                    const isOutOfStock = info.promo === 'Товар закончился';
                    rowHtml += `
                        <td>
                            <div class="small fw-bold ${isOutOfStock ? 'text-danger' : 'text-warning'}">${info.promo}</div>
                            <div class="text-secondary" style="font-size: 0.65rem; opacity: 0.5;">${info.sku}</div>
                        </td>`;
                } else {
                    rowHtml += `<td class="text-secondary opacity-25">---</td>`;
                }
            });

            rowHtml += `</tr>`;
            tbody.innerHTML += rowHtml;
        });
    }

    // Scroll listener for Infinite Scroll
    document.getElementById('table-scroll-container').addEventListener('scroll', function (e) {
        const { scrollTop, scrollHeight, clientHeight } = e.target;
        if (scrollTop + clientHeight >= scrollHeight - 50) {
            if (!isLoading && currentPage < totalPages) {
                currentPage++;
                loadTable(true);
            }
        }
    });

    // Handlers
    document.getElementById('ozon-btn').addEventListener('change', () => {
        currentPlatform = 'ozon';
        document.getElementById('filter-store').innerHTML = '<option value="">Все магазины</option>';
        currentPage = 1;
        document.getElementById('products-table-body').innerHTML = ''; // Clear table on platform change
        loadStats(); loadChart(); loadTable();
    });
    document.getElementById('wb-btn').addEventListener('change', () => {
        currentPlatform = 'wb';
        document.getElementById('filter-store').innerHTML = '<option value="">Все магазины</option>';
        currentPage = 1;
        document.getElementById('products-table-body').innerHTML = ''; // Clear table on platform change
        loadStats(); loadChart(); loadTable();
    });

    document.getElementById('apply-filters-btn').addEventListener('click', () => {
        currentPage = 1;
        document.getElementById('products-table-body').innerHTML = ''; // Clear table on filter apply
        loadTable();
    });

    // Keeping pagination buttons as fallback buttons (now "Show More" and "Reset")
    document.getElementById('prev-page-btn').addEventListener('click', () => {
        document.getElementById('products-table-body').innerHTML = '';
        currentPage = 1;
        loadTable();
    });
    document.getElementById('next-page-btn').addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            loadTable(true);
        }
    });

    document.getElementById('export-excel-btn').addEventListener('click', () => {
        const search = document.getElementById('filter-search').value;
        const store = document.getElementById('filter-store').value;
        const minPrice = document.getElementById('filter-min-price').value;
        const maxPrice = document.getElementById('filter-max-price').value;

        const url = `/api/dashboard/export?platform=${currentPlatform}&search=${encodeURIComponent(search)}&store=${encodeURIComponent(store)}&min_price=${minPrice}&max_price=${maxPrice}`;
        window.location.href = url;
    });

    // Initial load
    loadStats(); loadChart(); loadTable();
</script>
<style>
    .btn-check:checked+label,
    .btn.active {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)) !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        border: none !important;
    }

    .form-control-sm,
    .form-select-sm {
        font-size: 0.85rem;
    }

    #table-headers th {
        background: #0a0b10 !important;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        padding: 18px 10px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #94a3b8;
        position: sticky;
        top: 0;
        z-index: 25;
        white-space: nowrap;
    }

    /* Sticky columns for Matrix View */
    .view-matrix #table-headers th:first-child,
    .view-matrix #products-table-body td:first-child {
        position: sticky;
        left: 0;
        background: #0f1016 !important;
        z-index: 30;
        box-shadow: 5px 0 10px rgba(0, 0, 0, 0.5);
    }

    .view-matrix #table-headers th:first-child {
        z-index: 40;
        background: #0a0b10 !important;
    }

    #products-table-body tr {
        transition: var(--transition-smooth);
        border: none !important;
        background: #0f1016 !important;
    }

    #products-table-body td {
        border: none !important;
        background: transparent !important;
        color: white !important;
    }

    #products-table-body tr:hover {
        background: #1a1b23 !important;
        transform: scale(1.002) translateX(5px);
        box-shadow: inset 4px 0 0 var(--brand-primary), 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .sku-pill {
        background: rgba(255, 255, 255, 0.03);
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.75rem;
        color: #64748b;
        font-family: 'Outfit', sans-serif;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .name-cell {
        max-width: 450px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #ffffff !important;
        font-size: 0.95rem;
        letter-spacing: 0.3px;
    }

    .seller-badge {
        padding: 6px 12px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .badge-ozon {
        background: rgba(0, 91, 255, 0.1);
        color: #60a5fa;
        border-color: rgba(0, 91, 255, 0.2);
    }

    .badge-wb {
        background: rgba(168, 85, 247, 0.1);
        color: #c084fc;
        border-color: rgba(168, 85, 247, 0.2);
    }

    .badge-holod {
        background: rgba(34, 197, 94, 0.1);
        color: #4ade80;
        border-color: rgba(34, 197, 94, 0.2);
    }

    .price-primary {
        color: #22d3ee;
        font-size: 1.05rem;
        text-shadow: 0 0 15px rgba(34, 211, 238, 0.3);
    }

    .price-secondary {
        color: #f8fafc;
        font-size: 0.95rem;
    }

    .discount-pill {
        background: linear-gradient(135deg, #ef4444, #f43f5e);
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 6px;
        margin-left: 5px;
        font-weight: 800;
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        vertical-align: middle;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Premium Shimmer for Cards */
    .main-card {
        position: relative;
        overflow: hidden;
    }

    .main-card::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.01), transparent);
        transform: rotate(45deg);
        animation: shimmer 10s infinite linear;
        pointer-events: none;
    }

    @keyframes shimmer {
        0% {
            transform: translate(-30%, -30%) rotate(45deg);
        }

        100% {
            transform: translate(30%, 30%) rotate(45deg);
        }
    }
</style>
{% endblock %}