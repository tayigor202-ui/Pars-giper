{% extends "base.html" %}

{% block title %}Управление - Analytics{% endblock %}

{% block content %}
<div class="row mb-5">
    <div class="col-12">
        <h1 class="page-title" style="filter: drop-shadow(1px 1px 0px rgba(255,255,255,0.8));">
            <i class="bi bi-gear-wide-connected" style="color: var(--brand-primary);"></i> ЦЕНТР УПРАВЛЕНИЯ
        </h1>
        <p class="page-subtitle"
            style="letter-spacing: 2px; font-weight: 800; color: #5c4b3a; text-shadow: 1px 1px 0px #fff;">МАНИПУЛЯЦИЯ
            ПОТОКАМИ ДАННЫХ И ПРОЦЕССАМИ</p>
    </div>
</div>

<div class="row align-items-stretch">
    <div class="col-lg-5">
        <div class="main-card h-100">
            <h3 class="h5 mb-4 fw-bold" style="text-shadow: 1px 1px 0px #fff;"><i
                    class="bi bi-joystick me-2"></i>Командный блок</h3>

            <div class="d-grid gap-3 mb-4">
                <button id="start-parser-btn" class="btn btn-action btn-ozon py-3 skeu-raised">
                    <i class="bi bi-play-fill me-2"></i> ЗАПУСТИТЬ OZON
                </button>
                <button id="start-wb-parser-btn" class="btn btn-action btn-wb py-3">
                    <i class="bi bi-play-fill me-2"></i> ЗАПУСТИТЬ WB
                </button>
                <button id="start-lemana-parser-btn" class="btn btn-action btn-lemana py-3">
                    <i class="bi bi-play-fill me-2"></i> ЗАПУСТИТЬ LEMANA
                </button>
                <button id="start-ym-parser-btn" class="btn btn-action btn-ym py-3">
                    <i class="bi bi-play-fill me-2"></i> ЗАПУСТИТЬ Y.MARKET
                </button>
                <button id="stop-parser-btn" class="btn btn-danger-wool py-3">
                    <i class="bi bi-stop-fill me-2"></i> АВАРИЙНЫЙ ОСТАНОВ
                </button>
            </div>

            <hr class="border-secondary opacity-25 my-4">

            <h3 class="h5 mb-3 fw-bold" style="text-shadow: 1px 1px 0px #000;"><i
                    class="bi bi-cloud-download me-2"></i>Утилиты</h3>
            <div class="d-grid gap-3">
                <button id="git-pull-btn" class="btn btn-premium py-2">
                    <i class="bi bi-cloud-arrow-down-fill me-2"></i> СИНХРОНИЗАЦИЯ GIT
                </button>
            </div>

            <div id="status-message" class="mt-auto"></div>
        </div>
    </div>

    <div class="col-lg-7">
        <div class="main-card h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="h5 mb-0 fw-bold" style="text-shadow: 1px 1px 0px #fff;"><i
                        class="bi bi-terminal-fill me-2"></i>Терминал Вывода</h3>
                <span class="badge"
                    style="background: #e9e4d1; border: 1px solid #d4ceb8; color: #5c4b3a; box-shadow: inset 1px 1px 2px #fff;">LOG_ACTIVE</span>
            </div>

            <div id="mini-log-container" class="p-1"
                style="border-radius: 12px; position: relative; overflow: hidden; background: #0d0f14; border: 2px solid #333; box-shadow: inset 4px 4px 10px #000;">
                <div id="mini-log" class="font-monospace small p-3"
                    style="height: 400px; overflow-y: auto; color: #4ade80; background: transparent; border-radius: 8px;">
                    <span class="text-secondary">[SYSTEM]</span> Монитор готов к приему данных...
                </div>
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                    background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px); 
                    pointer-events: none; border-radius: 8px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const log = document.getElementById('mini-log');
    function addLog(msg, type = 'INFO') {
        const time = new Date().toLocaleTimeString();
        log.innerHTML += `<div class="mb-1"><span class="text-secondary">[${time}]</span> <span class="text-${type === 'ERROR' ? 'danger' : 'secondary'}">[${type}]</span> ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    document.getElementById('start-parser-btn').addEventListener('click', function () {
        addLog('Запрос на запуск Ozon отправлен...');
        fetch('/api/parser/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
            .then(r => r.json())
            .then(data => addLog(data.message, data.status === 'success' ? 'SUCCESS' : 'ERROR'));
    });

    document.getElementById('start-wb-parser-btn').addEventListener('click', function () {
        log.innerHTML = '<div class="text-warning">[SYSTEM] Подготовка к запуску WB...</div>';
        fetch('/api/parser/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ platform: 'wb' })
        })
            .then(r => r.json())
            .then(data => {
                addLog(data.message, data.status === 'success' ? 'SUCCESS' : 'ERROR');
                setTimeout(() => startLogPolling('wb'), 500);
            });
    });

    document.getElementById('start-lemana-parser-btn').addEventListener('click', function () {
        log.innerHTML = '<div class="text-warning">[SYSTEM] Подготовка к запуску Lemana Pro...</div>';
        fetch('/api/lemana/parser/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
            .then(r => r.json())
            .then(data => {
                addLog(data.message, data.status === 'success' ? 'SUCCESS' : 'ERROR');
                setTimeout(() => startLogPolling('lemana'), 500);
            });
    });

    document.getElementById('start-ym-parser-btn').addEventListener('click', function () {
        log.innerHTML = '<div class="text-warning">[SYSTEM] Подготовка к запуску Yandex Market...</div>';
        fetch('/api/ym/parser/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
            .then(r => r.json())
            .then(data => {
                addLog(data.message, data.status === 'success' ? 'SUCCESS' : 'ERROR');
                setTimeout(() => startLogPolling('ym_parser'), 500);
            });
    });

    document.getElementById('import-lemana-btn').addEventListener('click', function () {
        addLog('Запуск импорта Lemana Pro из Google Sheets...');
        const btn = this;
        btn.disabled = true;

        fetch('/api/lemana/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
            .then(r => r.json())
            .then(data => {
                addLog(data.message, data.status === 'success' ? 'SUCCESS' : 'ERROR');
            })
            .catch(err => addLog('Ошибка импорта: ' + err, 'ERROR'))
            .finally(() => {
                btn.disabled = false;
            });
    });

    document.getElementById('stop-parser-btn').addEventListener('click', function () {
        addLog('Остановка процессов...');
        fetch('/api/parser/stop', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
            .then(r => r.json())
            .then(data => addLog(data.message, 'WARNING'));
    });

    document.getElementById('git-pull-btn').addEventListener('click', function () {
        addLog('Запуск обновления из Git (git pull)...');
        const btn = this;
        btn.disabled = true;

        fetch('/api/git/pull', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
            .then(r => r.json())
            .then(data => {
                addLog(data.message, data.status === 'success' ? 'SUCCESS' : 'ERROR');
                if (data.output) {
                    addLog('Вывод Git:');
                    data.output.split('\n').filter(line => line.trim()).forEach(line => {
                        addLog(`> ${line}`, 'DEBUG');
                    });
                }
            })
            .catch(err => addLog('Ошибка сети: ' + err, 'ERROR'))
            .finally(() => {
                btn.disabled = false;
            });
    });

    // Logging integration
    let logInterval = null;
    let currentPlatform = null;

    function startLogPolling(platform) {
        if (logInterval) clearInterval(logInterval);
        currentPlatform = platform;

        logInterval = setInterval(() => {
            fetch(`/api/parser/logs?platform=${platform}&limit=100`)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success' && data.logs && data.logs.length > 0) {
                        // For terminal experience, we replace the log area with recent file lines
                        // but only if there's actual output to show
                        const logHeader = `<div class="text-info mb-2">--- Живой лог: ${platform.toUpperCase()} ---</div>`;
                        const lines = data.logs.map(line => {
                            let type = 'secondary';
                            if (line.includes('ERROR') || line.includes('Exception')) type = 'danger';
                            if (line.includes('SUCCESS') || line.includes('OK')) type = 'success';
                            if (line.includes('[INFO]')) type = 'info';

                            return `<div class="mb-0 small"><span class="text-${type}">${line.replace(/\n$/, '')}</span></div>`;
                        }).join('');

                        log.innerHTML = logHeader + lines;
                        log.scrollTop = log.scrollHeight;
                    }
                })
                .catch(err => console.error('Log fetch error:', err));
        }, 2000);
    }

    // Wrap start buttons to initiate polling
    document.getElementById('start-parser-btn').addEventListener('click', () => {
        log.innerHTML = '<div class="text-warning">[SYSTEM] Подготовка к запуску Ozon...</div>';
        setTimeout(() => startLogPolling('ozon'), 500);
    });

    document.getElementById('start-wb-parser-btn').addEventListener('click', () => {
        log.innerHTML = '<div class="text-warning">[SYSTEM] Подготовка к запуску WB...</div>';
        setTimeout(() => startLogPolling('wb'), 500);
    });

    document.getElementById('stop-parser-btn').addEventListener('click', () => {
        if (logInterval) {
            addLog('Логирование остановлено.');
            // We don't clear interval immediately to see final results
            setTimeout(() => {
                clearInterval(logInterval);
                logInterval = null;
            }, 3000);
        }
    });

</script>
{% endblock %}