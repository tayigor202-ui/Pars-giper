# Анализ обхода защиты OZON (Техническое описание)

Этот документ описывает многоуровневую стратегию обхода антифрод-систем OZON, реализованную в текущем парсере. Описание структурировано по уровням воздействия: от сетевого до уровня имитации поведения.

## 1. Сетевой уровень (Network Layer)

### Прокси-пул и ротация
- **Тип:** Используются быстрые HTTP-прокси с поддержкой авторизации.
- **Ротация:** Каждый из 30 воркеров (`NUM_WORKERS=30`) работает через свой уникальный прокси-канал.
- **Очистка кэша:** При смене прокси или падении воркера Chrome-профиль может быть очищен, чтобы избежать связи старого заблокированного сеанса с новым IP.

### Синхронизация Геолокации и Timezone (Критично)
Это одна из самых "умных" частей парсера:
1. Система запрашивает геолокацию текущего IP через `ip-api.com`.
2. Определяет точный часовой пояс (например, `Europe/Samara`).
3. **CDP Injection:** Через Chrome DevTools Protocol подменяет `Date.prototype.getTimezoneOffset` в браузере.
   - *Зачем:* Антифрод OZON видит, что IP-адрес из Казани, и системное время браузера ТАКЖЕ соответствует Казани. Если бы был разрыв (IP из Казани, а время Московское), это был бы 100% триггер для капчи.

## 2. Уровень отпечатка браузера (Fingerprinting)

### Скрытие автоматизации (Evasion)
Используется метод инъекции JS-кода через CDP на этапе создания документа (`addScriptToEvaluateOnNewDocument`), что позволяет подменить параметры ДО того, как сайты успеют их проверить:
- **`navigator.webdriver = undefined`**: Скрывает основной признак Selenium.
- **`navigator.languages = ['ru-RU', 'ru']`**: Имитирует русскоязычного пользователя.
- **`window.chrome = {runtime: {}}`**: Добавляет объект, который есть у реального Chrome, но отсутствует в автоматизированных версиях.
- **Подмена плагинов:** Имитирует наличие стандартных плагинов (Chrome PDF Viewer и т.д.), чтобы отпечаток не выглядел "голым".

### Рандомизация окружения
- **User-Agent:** Скрипт генерирует реалистичный UA (например, Chrome 131.0.6778.86).
- **Разрешение экрана:** Рандомизируется выбор из популярных десктопных разрешений (1920x1080, 1440x900 и т.д.).
- **Window Size:** Окно реально открывается с этим размером, что влияет на рендеринг и проверку видимости элементов.

## 3. Оптимизация и маскировка трафика

### Блокировка медиа-ресурсов
Парсер агрессивно блокирует загрузку:
- Изображений (`*.jpg`, `*.png`, `*.webp`).
- Шрифтов и SVG.
- Метрик (`google-analytics`, `yandex.ru/metrika`).
- Рекламных сетей.
- *Эффект:* Экономия 90% трафика прокси и ускорение загрузки в 3-5 раз, что делает "поведение" более похожим на API-запрос, но внутри полноценного браузера.

### Кастомные заголовки (Extra Headers)
Через CDP устанавливаются специфические заголовки `sec-ch-ua`, `sec-ch-ua-platform`, `Sec-Fetch-Dest` и т.д., которые в точности соответствуют поведению актуальных версий Chrome.

## 4. Поведенческий уровень (Behavioral Analysis)

### Имитация сессии
- **Cookie Injection:** Перед началом работы парсер заходит на главную страницу и принудительно устанавливает технические куки (`__Secure-ab-group`, `__Secure-user-id`). Это заставляет OZON думать, что пользователь не "первоход", а уже имеет какую-то историю просмотров.
- **Задержки:** Используются случайные паузы (`random.uniform(2.0, 7.0)`) между товарами и длинные паузы между пачками (batches).

## 5. Обработка блокировок

### Детектирование Antibot
Скрипт мониторит содержимое страницы на наличие стоп-слов:
- `cloudflare`
- `captcha`
- `Проверка безопасности`
- `Пройдите проверку`

Если `is_antibot` становится `True` слишком часто, система выставляет флаг `antibot_detected`, что может привести к полной остановке или перезагрузке всех воркеров с новыми прокси.

## Резюме для "понимания":
Парсер не просто "заходит на сайт". Он создает **полную цифровую личность**: у него есть правильный IP, соответствующий этому IP город и время, реальная версия браузера со всеми куками и плагинами. Он блокирует все лишнее, чтобы работать быстро, но оставляет все "улики" реального человека для системы защиты OZON.
